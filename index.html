<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡å­—ä¸‰è§’æ´²ï¼šé›¶å·å¤§å (å‡çº§ç‰ˆ)</title>
    <style>
        :root {
            --bg-color: #0d1117;
            --panel-bg: #161b22;
            --card-bg: #21262d;
            --text-main: #c9d1d9;
            --highlight: #58a6ff; /* ç§‘æŠ€è“ */
            --danger: #f85149;
            --gold: #e3b341;
            --purple: #d2a8ff;
            --green: #3fb950;
            --selected-border: #238636;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
        }

        /* é¡¶éƒ¨çŠ¶æ€æ  */
        #status-bar {
            background-color: #010409;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #30363d;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            z-index: 10;
        }

        .resource-item {
            display: inline-flex;
            align-items: center;
            margin-right: 15px;
            font-size: 14px;
            font-weight: bold;
        }

        /* ä¸»å®¹å™¨ */
        #main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* å±å¹•é¡µé¢åˆ‡æ¢ */
        .screen {
            display: none;
            flex-direction: column;
            height: 100%;
            box-sizing: border-box;
            overflow-y: auto;
            padding-bottom: 80px; /* ä¸ºåº•éƒ¨æŒ‰é’®ç•™ç©º */
        }

        .screen.active {
            display: flex;
        }

        /* --- å¤‡æˆ˜å¤§å…æ ·å¼ --- */
        
        .lobby-section {
            padding: 15px;
        }

        .section-title {
            color: var(--highlight);
            font-size: 16px;
            border-left: 4px solid var(--highlight);
            padding-left: 10px;
            margin: 10px 0 15px 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .card-scroll-view {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding-bottom: 10px;
            scrollbar-width: none; /* Firefox */
        }
        .card-scroll-view::-webkit-scrollbar { display: none; }

        .card {
            background: var(--card-bg);
            border: 2px solid #30363d;
            border-radius: 8px;
            min-width: 140px;
            width: 140px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .card:hover { transform: translateY(-2px); }

        /* é€‰ä¸­çŠ¶æ€ */
        .card.selected {
            border-color: var(--highlight);
            box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.4);
            background-color: #1f2937;
        }
        
        .card.selected::after {
            content: "âœ”";
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--highlight);
            color: black;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .card-img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            background: #000;
            border-bottom: 1px solid #30363d;
        }

        .card-body {
            padding: 10px;
        }

        .card-title {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .card-desc {
            font-size: 11px;
            color: #8b949e;
            margin-bottom: 5px;
        }

        .stat-badges {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }
        .badge {
            font-size: 10px;
            padding: 2px 4px;
            border-radius: 4px;
            background: #30363d;
        }

        /* åº•éƒ¨å›ºå®šè´¦å•æ  */
        #checkout-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #0d1117;
            border-top: 1px solid #30363d;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-sizing: border-box;
            z-index: 100;
        }

        .bill-info {
            font-size: 14px;
        }
        .total-price {
            color: var(--gold);
            font-size: 18px;
            font-weight: bold;
        }

        .btn-start {
            background: var(--highlight);
            color: #000;
            border: none;
            padding: 10px 25px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
        }
        .btn-start:disabled { background: #555; cursor: not-allowed; }

        /* é˜²å…·æ»‘å— */
        .armor-control {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #30363d;
            margin-top: 10px;
        }
        input[type=range] {
            width: 100%;
            accent-color: var(--highlight);
            margin: 15px 0;
        }

        /* --- æ¸¸æˆå†…æ ·å¼ --- */
        #game-log {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #0d1117;
        }
        .log-entry { margin-bottom: 12px; line-height: 1.5; font-size: 15px; border-left: 2px solid #30363d; padding-left: 10px; }
        .log-entry.new { animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }

        .text-blue { color: var(--highlight); }
        .text-red { color: var(--danger); }
        .text-gold { color: var(--gold); }
        
        #action-panel {
            background: #161b22;
            padding: 15px;
            border-top: 1px solid #30363d;
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }
        
        .btn-option {
            background: #21262d;
            color: var(--text-main);
            border: 1px solid #30363d;
            padding: 12px;
            text-align: left;
            border-radius: 6px;
            cursor: pointer;
            transition: 0.2s;
        }
        .btn-option:hover { background: #30363d; border-color: var(--highlight); }

        /* ç»“ç®—é¡µ */
        .result-container {
            padding: 40px 20px;
            text-align: center;
        }
        .loot-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }
        .loot-item {
            background: #21262d;
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            border: 1px solid #333;
        }
        .loot-item.tier-5 { border-color: var(--danger); color: var(--danger); }
        .loot-item.tier-4 { border-color: var(--gold); color: var(--gold); }
        .loot-item.tier-3 { border-color: var(--purple); color: var(--purple); }

    </style>
</head>
<body>

    <!-- é¡¶éƒ¨å¸¸é©»èµ„æºæ  -->
    <div id="status-bar">
        <div class="resource-item">
            <span style="color: var(--gold); margin-right:5px;">ğŸª™</span>
            <span id="ui-money">500,000</span>
        </div>
        <div class="resource-item">
            <span style="color: var(--danger); margin-right:5px;">â¤ï¸</span>
            <span id="ui-hp">100%</span>
        </div>
        <div class="resource-item">
            <span style="color: var(--purple); margin-right:5px;">ğŸ’</span>
            <span id="ui-bag-val">0</span>
        </div>
    </div>

    <div id="main-container">

        <!-- 1. å¤‡æˆ˜å¤§å… (Lobby) -->
        <div id="screen-lobby" class="screen active">
            
            <div class="lobby-section">
                <div class="section-title">/// é€‰æ‹©ç‰¹å‹¤å¹²å‘˜ ///</div>
                <div class="card-scroll-view" id="char-select-container">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>

                <div class="section-title" style="margin-top:25px">/// é‡‡è´­ä¸»æ­¦å™¨ ///</div>
                <div class="card-scroll-view" id="weapon-select-container">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>

                <div class="section-title" style="margin-top:25px">/// é˜²å…·ç­‰çº§ ///</div>
                <div class="armor-control">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <span>é˜²å¼¹è¡£ç­‰çº§: <span id="armor-level-text" class="text-blue">æ— é˜²å…·</span></span>
                        <span id="armor-price-text" class="text-gold">$0</span>
                    </div>
                    <input type="range" id="armor-slider" min="0" max="3" value="0" step="1">
                    <div style="font-size:12px; color:#666;">
                        * æå‡ç”Ÿå­˜ç‡ä¸å¹¸è¿å€¼ï¼Œä½†ä¼šå¢åŠ å‡ºå‡»æˆæœ¬ã€‚
                    </div>
                </div>
            </div>

            <!-- åº•éƒ¨è´¦å•ä¸å¼€å§‹æŒ‰é’® -->
            <div id="checkout-bar">
                <div class="bill-info">
                    <div>å½“å‰ä½™é¢: <span id="ui-balance-preview">500000</span></div>
                    <div>å‡ºå‡»èŠ±è´¹: <span class="total-price" id="ui-total-cost">0</span></div>
                </div>
                <button class="btn-start" onclick="Game.attemptStart()">å¼€å§‹è¡ŒåŠ¨</button>
            </div>
        </div>

        <!-- 2. æˆ˜æ–—ç•Œé¢ (In-Game) -->
        <div id="screen-game" class="screen">
            <div id="game-location-header" style="padding:10px; background:#111; font-size:12px; color:#666; text-align:center;">
                DEPLOYED AT: <span id="ui-loc-name" style="color:#fff">LOADING...</span>
            </div>
            <div id="game-log"></div>
            <div id="action-panel"></div>
        </div>

        <!-- 3. ç»“ç®—ç•Œé¢ (Result) -->
        <div id="screen-result" class="screen">
            <div class="result-container">
                <h1 id="res-title">è¡ŒåŠ¨ç»“æŸ</h1>
                <p id="res-desc">ç»“ç®—ä¿¡æ¯...</p>
                <h2 class="text-gold">æ”¶ç›Š: +<span id="res-money">0</span></h2>
                
                <div style="text-align:left; margin-top:20px; font-size:14px; color:#888;">ç‰©èµ„æ¸…å•:</div>
                <div class="loot-grid" id="res-loot-grid"></div>

                <button class="btn-start" style="width:100%; margin-top:30px;" onclick="Game.toLobby()">è¿”å›åŸºåœ°</button>
            </div>
        </div>

    </div>

<script>
/**
 * æ¸¸æˆé…ç½®æ•°æ®
 * imgUrl: è¿™é‡Œä½¿ç”¨äº†å ä½ç¬¦å›¾ç‰‡æœåŠ¡ï¼Œä½ å¯ä»¥æ¢æˆå…·ä½“çš„å›¾ç‰‡é“¾æ¥
 */
const DATA = {
    chars: [
        { 
            id: 'dragon', name: 'å¨é¾™', role: 'çªå‡»', 
            desc: 'ç²¾é€šæ­£é¢ä½œæˆ˜ï¼Œæˆ˜åŠ›æé«˜', 
            stats: { atk: 9, surv: 5, luck: 5 },
            img: 'https://placehold.co/140x100/1a1a1a/FFF?text=å¨é¾™'
        },
        { 
            id: 'bee', name: 'èœ‚åŒ»', role: 'æ”¯æ´', 
            desc: 'æ‹¥æœ‰è‡ªæ•‘èƒ½åŠ›ï¼Œç”šè‡³èƒ½é€ƒè·‘', 
            stats: { atk: 5, surv: 9, luck: 5 },
            img: 'https://placehold.co/140x100/1a1a1a/FFF?text=èœ‚åŒ»'
        },
        { 
            id: 'wolf', name: 'çº¢ç‹¼', role: 'ä¾¦æŸ¥', 
            desc: 'èƒ½æå‰å‘ç°å±é™©å¹¶è§„é¿', 
            stats: { atk: 6, surv: 6, luck: 4 },
            img: 'https://placehold.co/140x100/1a1a1a/FFF?text=çº¢ç‹¼'
        },
        { 
            id: 'runner', name: 'ç‰¹å‹¤å¹²å‘˜', role: 'é€šç”¨', 
            desc: 'åŸºç¡€å¹²å‘˜ï¼Œå¹¸è¿è¾ƒé«˜', 
            stats: { atk: 3, surv: 3, luck: 8 },
            img: 'https://placehold.co/140x100/1a1a1a/FFF?text=å¹²å‘˜'
        }
    ],
    weapons: [
        { 
            id: 'knife', name: 'æˆ˜æœ¯åŒ•é¦–', type: 'close', cost: 0, power: 10,
            desc: 'æ— èŠ±è´¹ï¼Œè·‘åˆ€é¦–é€‰',
            img: 'https://placehold.co/140x100/333/FFF?text=åŒ•é¦–' 
        },
        { 
            id: 'smg', name: 'MP5å†²é”‹æª', type: 'close', cost: 15000, power: 35,
            desc: 'è¿‘è·ç¦»å°„é€Ÿæå¿«',
            img: 'https://placehold.co/140x100/333/FFF?text=MP5' 
        },
        { 
            id: 'ar', name: 'M4A1æ­¥æª', type: 'mid', cost: 45000, power: 55,
            desc: 'ä¸­è¿œè·ç¦»å‡è¡¡å…¨èƒ½',
            img: 'https://placehold.co/140x100/333/FFF?text=M4A1' 
        },
        { 
            id: 'sniper', name: 'AWMç‹™å‡»æª', type: 'far', cost: 70000, power: 80,
            desc: 'æè¿œè·ç¦»ä¸€å‡»å¿…æ€',
            img: 'https://placehold.co/140x100/333/FFF?text=AWM' 
        }
    ],
    armorCosts: [0, 20000, 50000, 100000], // 0-3çº§é˜²å…·ä»·æ ¼
    armorNames: ['æ— é˜²å…·', 'ä¸€çº§ç”² (è½»å‹)', 'ä¸‰çº§ç”² (æ ‡å‡†)', 'äº”çº§ç”² (é‡å‹)'],
    
    // æ‰è½è¡¨
    loot: [
        { name: 'èºä¸é’‰', val: 500, tier: 1 },
        { name: 'æ‰“ç«æœº', val: 1500, tier: 1 },
        { name: 'CPUé£æ‰‡', val: 4000, tier: 2 },
        { name: 'é›†æ¢å¼å¡ç‰Œ', val: 12000, tier: 2 },
        { name: 'é‡‘æ¡', val: 40000, tier: 3 },
        { name: 'æ›¼å¾·å°”ç –', val: 150000, tier: 4 },
        { name: 'ã€éæ´²ä¹‹å¿ƒã€‘', val: 1200000, tier: 5 }
    ]
};

const State = {
    money: 500000,
    pityLuck: 0,
    
    // å¤‡æˆ˜é€‰æ‹©çŠ¶æ€
    selected: {
        charIndex: -1,
        weaponIndex: -1,
        armorLevel: 0
    },

    // å±€å†…çŠ¶æ€
    inGame: {
        hp: 100,
        bagValue: 0,
        bagItems: [],
        luck: 0,
        isDead: false
    }
};

const Game = {
    init: function() {
        UI.initLobby();
        UI.updateBalance();
    },

    // --- å¤‡æˆ˜é€»è¾‘ ---

    selectChar: function(idx) {
        State.selected.charIndex = idx;
        UI.renderSelectionState();
    },

    selectWeapon: function(idx) {
        State.selected.weaponIndex = idx;
        UI.renderSelectionState();
        UI.updateCostPreview();
    },

    setArmor: function(val) {
        State.selected.armorLevel = parseInt(val);
        document.getElementById('armor-level-text').innerText = DATA.armorNames[val];
        document.getElementById('armor-price-text').innerText = '$' + DATA.armorCosts[val];
        UI.updateCostPreview();
    },

    // è®¡ç®—æ€»èŠ±è´¹
    calculateCost: function() {
        let cost = 0;
        if (State.selected.weaponIndex !== -1) {
            cost += DATA.weapons[State.selected.weaponIndex].cost;
        }
        cost += DATA.armorCosts[State.selected.armorLevel];
        return cost;
    },

    attemptStart: function() {
        if (State.selected.charIndex === -1) {
            alert("è¯·é€‰æ‹©ä¸€åå¹²å‘˜ï¼");
            return;
        }
        if (State.selected.weaponIndex === -1) {
            alert("è¯·é€‰æ‹©ä¸»æ­¦å™¨ï¼");
            return;
        }

        const totalCost = this.calculateCost();
        if (State.money < totalCost) {
            alert("èµ„é‡‘ä¸è¶³ï¼è¯·è°ƒæ•´è£…å¤‡æˆ–é€‰æ‹©è·‘åˆ€ã€‚");
            return;
        }

        // æ‰£è´¹å¹¶å¼€å§‹
        State.money -= totalCost;
        this.startRun(totalCost);
    },

    startRun: function(investedCost) {
        // åˆå§‹åŒ–æ•°å€¼
        const char = DATA.chars[State.selected.charIndex];
        // å¹¸è¿å…¬å¼ï¼šè§’è‰²åŸºç¡€ + (è£…å¤‡æŠ•å…¥/10000) + è¿è´¥è¡¥å¿
        const gearLuck = Math.floor(investedCost / 10000);
        
        State.inGame = {
            hp: 100,
            bagValue: 0,
            bagItems: [],
            luck: char.stats.luck + gearLuck + State.pityLuck,
            isDead: false
        };

        UI.switchScreen('screen-game');
        UI.updateBalance();
        UI.updateInGameStatus();
        UI.clearLog();

        // éšæœºå‡ºç”Ÿ
        const spawnType = Math.random() > 0.5 ? 'EAST' : 'WEST';
        this.triggerNode(spawnType === 'EAST' ? 'SPAWN_EAST' : 'SPAWN_WEST');
    },

    // --- æ¸¸æˆå¾ªç¯ ---

    triggerNode: function(nodeId) {
        UI.setLoc(nodeId);
        
        const char = DATA.chars[State.selected.charIndex];
        const weapon = DATA.weapons[State.selected.weaponIndex];

        // ç®€åŒ–çš„å‰§æœ¬é€»è¾‘
        if (nodeId === 'SPAWN_EAST') {
            UI.log(`>> éƒ¨ç½²å®Œæˆï¼šé›¶å·å¤§åã€ä¸œä¾§ã€‘ã€‚`, 'text-blue');
            UI.log(`å¹²å‘˜ ${char.name} å·²å°±ä½ï¼Œæ‰‹æŒ ${weapon.name}ã€‚`);
            UI.showActions([
                { text: "å¼ºæ”»è¡Œæ”¿æ¥¼ (é«˜é£é™©)", cb: () => this.triggerNode('ADMIN_BUILDING') },
                { text: "æ‘¸ç´¢æ¸¸å®¢ä¸­å¿ƒ (ä¸­é£é™©)", cb: () => this.triggerNode('VISITOR_CENTER') },
                { text: "å¤–å›´æ¶æª (ä½é£é™©)", cb: () => this.triggerNode('CAMPING') }
            ]);
        } 
        else if (nodeId === 'SPAWN_WEST') {
            UI.log(`>> éƒ¨ç½²å®Œæˆï¼šé›¶å·å¤§åã€è¥¿ä¾§ã€‘ã€‚`, 'text-blue');
            UI.showActions([
                { text: "çªå‡»ä¸»æ¥¼è¥¿ä¾§ (é«˜é£é™©)", cb: () => this.triggerNode('MAIN_WEST') },
                { text: "æœåˆ®æ°´æ³¥å‚ (ä½é£é™©)", cb: () => this.triggerNode('FACTORY') }
            ]);
        }
        else if (['ADMIN_BUILDING', 'MAIN_WEST'].includes(nodeId)) {
            UI.log("è¿›å…¥é«˜ä»·å€¼åŒºåŸŸï¼Œå››å‘¨è„šæ­¥å£°æ‚ä¹±...", 'text-red');
            this.encounter(0.7, 'elite', 100, nodeId); // 70%æ¦‚ç‡é‡æ•Œ
        }
        else if (['VISITOR_CENTER', 'FACTORY'].includes(nodeId)) {
            UI.log("åŒºåŸŸç›¸å¯¹å®‰é™ï¼Œå¼€å§‹æœå¯»ç‰©èµ„ã€‚");
            this.encounter(0.3, 'scav', 40, nodeId); // 30%æ¦‚ç‡é‡æ•Œ
        }
        else if (nodeId === 'CAMPING') {
            UI.log("ä½ è¶´åœ¨è‰ä¸›ä¸­ç­‰å¾…çŒç‰©...");
            if (Math.random() > 0.5) this.encounter(1.0, 'player', 60, nodeId);
            else {
                UI.log("ç­‰äº†åŠå¤©æ²¡çœ‹åˆ°äººã€‚");
                this.handleSearch();
            }
        }
        else if (nodeId === 'EXTRACT') {
            UI.log(">> æŠµè¾¾æ’¤ç¦»ç‚¹ï¼Œç›´å‡æœºå·²é™è½ï¼", 'text-green');
            UI.showActions([
                { text: "ç¡®è®¤æ’¤ç¦»", cb: () => this.finish(true) }
            ]);
        }
    },

    encounter: function(prob, enemyType, power, locId) {
        if (Math.random() > prob) {
            // å®‰å…¨ï¼Œç›´æ¥æœåˆ®
            this.handleSearch();
            return;
        }

        let enemyName = enemyType === 'elite' ? 'å…¨è£…ç‰¹é£é˜Ÿ' : (enemyType === 'player' ? 'è·‘åˆ€ç©å®¶' : 'æ¸¸è¡è€…');
        UI.log(`âš ï¸ æ¥è§¦æ•Œå¯¹ç›®æ ‡ï¼š[${enemyName}]`, 'text-red');

        // ä¾¦æŸ¥è§’è‰²ç‰¹æƒ
        if (DATA.chars[State.selected.charIndex].id === 'wolf' && Math.random() < 0.6) {
            UI.showActions([
                { text: "[çº¢ç‹¼å¤©èµ‹] è§„é¿æˆ˜æ–—", cb: () => { UI.log("ä¾é å¬è§‰ç»•è¿‡äº†æ•Œäººã€‚"); this.handleSearch(); } },
                { text: "å¼€ç«æˆ˜æ–—", cb: () => this.combat(power) }
            ]);
            return;
        }

        UI.showActions([
            { text: "å¼€ç«æˆ˜æ–—", cb: () => this.combat(power) }
        ]);
    },

    combat: function(enemyPower) {
        const char = DATA.chars[State.selected.charIndex];
        const weapon = DATA.weapons[State.selected.weaponIndex];
        const armor = State.selected.armorLevel;

        // æˆ˜åŠ›è®¡ç®—
        let myPower = (char.stats.atk * 8) + weapon.power + (armor * 15);
        // éšæœºæ³¢åŠ¨
        let roll = Math.floor(Math.random() * 40); 
        let finalPower = myPower + roll;

        UI.log(`äº¤ç«ä¸­... æˆ˜åŠ›åˆ¤å®š: ${finalPower} vs ${enemyPower + 20}`);

        if (finalPower >= enemyPower) {
            UI.log(">> å‡»æ€ç›®æ ‡ï¼è·å¾—æˆ˜åˆ©å“ã€‚", 'text-green');
            this.addLoot({ name: 'æ•Œäººç‹—ç‰Œ/è£…å¤‡', val: enemyPower * 150, tier: 3 });
            this.handleSearch();
        } else {
            // æˆ˜è´¥
            if (char.id === 'bee' && Math.random() < 0.5) {
                UI.log("[èœ‚åŒ»å¤©èµ‹] é‡ä¼¤å€’åœ°ï¼Œä½†åœ¨çƒŸé›¾æ©æŠ¤ä¸‹çˆ¬èµ°äº†ï¼", 'text-purple');
                State.inGame.hp = 10;
                State.inGame.bagValue = Math.floor(State.inGame.bagValue / 2);
                UI.updateInGameStatus();
                this.handleSearch();
            } else {
                this.finish(false);
            }
        }
    },

    handleSearch: function() {
        // æœåˆ®é€»è¾‘
        const luck = State.inGame.luck;
        const roll = Math.floor(Math.random() * 100) + luck;
        
        let found = DATA.loot[0]; // é»˜è®¤åƒåœ¾
        if (roll > 130) found = DATA.loot[6]; // å¤§çº¢
        else if (roll > 110) found = DATA.loot[5];
        else if (roll > 90) found = DATA.loot[4];
        else if (roll > 60) found = DATA.loot[3];
        else if (roll > 30) found = DATA.loot[2];

        UI.log(`æœç´¢ç®±å­å‘ç°: ${found.name}`, found.tier >= 4 ? 'text-gold' : '');
        this.addLoot(found);

        // å†³ç­–ä¸‹ä¸€æ­¥
        if (State.inGame.bagItems.length >= 3 || Math.random() > 0.7) {
            setTimeout(() => this.triggerNode('EXTRACT'), 1000);
        } else {
            UI.showActions([
                { text: "å¯»æ‰¾ä¸‹ä¸€ä¸ªæœåˆ®ç‚¹", cb: () => {
                    const next = Math.random() > 0.5 ? 'VISITOR_CENTER' : 'FACTORY';
                    this.triggerNode(next);
                }}
            ]);
        }
    },

    addLoot: function(item) {
        State.inGame.bagItems.push(item);
        State.inGame.bagValue += item.val;
        UI.updateInGameStatus();
    },

    finish: function(success) {
        UI.switchScreen('screen-result');
        const rTitle = document.getElementById('res-title');
        const rDesc = document.getElementById('res-desc');
        const rMoney = document.getElementById('res-money');
        const rGrid = document.getElementById('res-loot-grid');

        rGrid.innerHTML = '';

        if (success) {
            rTitle.innerText = "æ’¤ç¦»æˆåŠŸ";
            rTitle.style.color = "var(--green)";
            rDesc.innerText = "ç‰©èµ„å·²æˆåŠŸå¸¦å‡ºã€‚";
            rMoney.innerText = State.inGame.bagValue;
            
            State.money += State.inGame.bagValue;
            State.pityLuck = 0; // æ¸…é™¤è¡¥å¿

            State.inGame.bagItems.forEach(item => {
                rGrid.innerHTML += `<div class="loot-item tier-${item.tier}">${item.name}<br>$${item.val}</div>`;
            });
        } else {
            rTitle.innerText = "è¡ŒåŠ¨å¤±è´¥";
            rTitle.style.color = "var(--danger)";
            rDesc.innerText = "å¹²å‘˜é˜µäº¡ï¼Œç‰©èµ„å…¨éƒ¨ä¸¢å¤±ã€‚";
            rMoney.innerText = "0";
            
            State.pityLuck += 5;
            rGrid.innerHTML = `<div class="loot-item tier-3">å¹¸è¿è¡¥å¿ +5</div>`;
        }
        UI.updateBalance();
    },

    toLobby: function() {
        UI.switchScreen('screen-lobby');
    }
};

const UI = {
    initLobby: function() {
        // æ¸²æŸ“å¹²å‘˜å¡ç‰‡
        const charHtml = DATA.chars.map((c, i) => `
            <div class="card" onclick="Game.selectChar(${i})" id="char-card-${i}">
                <img src="${c.img}" class="card-img">
                <div class="card-body">
                    <div class="card-title">${c.name}</div>
                    <div class="card-desc">${c.role} | ${c.desc}</div>
                    <div class="stat-badges">
                        <span class="badge">âš”ï¸${c.stats.atk}</span>
                        <span class="badge">ğŸ›¡ï¸${c.stats.surv}</span>
                        <span class="badge">ğŸ€${c.stats.luck}</span>
                    </div>
                </div>
            </div>
        `).join('');
        document.getElementById('char-select-container').innerHTML = charHtml;

        // æ¸²æŸ“æ­¦å™¨å¡ç‰‡
        const weapHtml = DATA.weapons.map((w, i) => `
            <div class="card" onclick="Game.selectWeapon(${i})" id="weap-card-${i}">
                <img src="${w.img}" class="card-img">
                <div class="card-body">
                    <div class="card-title">${w.name}</div>
                    <div class="card-desc">${w.desc}</div>
                    <div class="text-gold" style="font-size:12px; font-weight:bold; margin-top:5px">$${w.cost}</div>
                </div>
            </div>
        `).join('');
        document.getElementById('weapon-select-container').innerHTML = weapHtml;

        // é˜²å…·æ»‘å—äº‹ä»¶
        document.getElementById('armor-slider').oninput = function() {
            Game.setArmor(this.value);
        };
    },

    renderSelectionState: function() {
        // æ¸…é™¤æ—§é€‰ä¸­
        document.querySelectorAll('.card').forEach(el => el.classList.remove('selected'));
        
        // é«˜äº®æ–°é€‰ä¸­
        if (State.selected.charIndex !== -1) {
            document.getElementById(`char-card-${State.selected.charIndex}`).classList.add('selected');
        }
        if (State.selected.weaponIndex !== -1) {
            document.getElementById(`weap-card-${State.selected.weaponIndex}`).classList.add('selected');
        }
    },

    updateCostPreview: function() {
        const total = Game.calculateCost();
        document.getElementById('ui-total-cost').innerText = '$' + total;
        
        // ä½™é¢é¢„è­¦
        const balanceSpan = document.getElementById('ui-balance-preview');
        balanceSpan.style.color = State.money < total ? 'var(--danger)' : 'var(--text-main)';
    },

    updateBalance: function() {
        document.getElementById('ui-money').innerText = State.money.toLocaleString();
        document.getElementById('ui-balance-preview').innerText = State.money.toLocaleString();
    },

    updateInGameStatus: function() {
        document.getElementById('ui-hp').innerText = State.inGame.hp + '%';
        document.getElementById('ui-bag-val').innerText = State.inGame.bagValue.toLocaleString();
    },

    log: function(msg, cls='') {
        const box = document.getElementById('game-log');
        const div = document.createElement('div');
        div.className = `log-entry new ${cls}`;
        div.innerText = msg;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    },

    clearLog: function() {
        document.getElementById('game-log').innerHTML = '';
    },

    showActions: function(actions) {
        const panel = document.getElementById('action-panel');
        panel.innerHTML = '';
        actions.forEach(act => {
            const btn = document.createElement('div');
            btn.className = 'btn-option';
            btn.innerText = `> ${act.text}`;
            btn.onclick = () => {
                // ç‚¹å‡»åæ¸…ç©ºé˜²æ­¢é‡å¤ç‚¹
                panel.innerHTML = ''; 
                act.cb();
            };
            panel.appendChild(btn);
        });
    },

    setLoc: function(id) {
        const map = {
            'SPAWN_EAST': 'ä¸œä¾§éƒ¨ç½²ç‚¹', 'SPAWN_WEST': 'è¥¿ä¾§éƒ¨ç½²ç‚¹',
            'ADMIN_BUILDING': 'è¡Œæ”¿æ¥¼Â·äºŒå±‚', 'VISITOR_CENTER': 'æ¸¸å®¢ä¸­å¿ƒ',
            'MAIN_WEST': 'è¥¿æ¥¼Â·å®éªŒå®¤', 'FACTORY': 'åºŸå¼ƒæ°´æ³¥å‚',
            'CAMPING': 'é‡å¤–Â·ç‹™å‡»ä½', 'EXTRACT': 'æ’¤ç¦»ç‚¹H01'
        };
        document.getElementById('ui-loc-name').innerText = map[id] || id;
    },

    switchScreen: function(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }
};

// å¯åŠ¨
Game.init();

</script>
</body>
</html>
