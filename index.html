<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ–‡å­—ä¸‰è§’æ´² V4.0ï¼šæˆ˜ç»©ä¸ç»æµ</title>
    <style>
        :root {
            --bg-color: #0d1117;
            --panel-bg: #161b22;
            --card-bg: #21262d;
            --text-main: #e6edf3;
            --highlight: #58a6ff;
            --danger: #ff6b6b;
            --gold: #e3b341;
            --green: #3fb950;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, monospace;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
        }

        /* é¡¶éƒ¨çŠ¶æ€æ  */
        #status-bar {
            height: 40px; background-color: #010409; padding: 0 15px;
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid #30363d; z-index: 20; font-size: 13px; flex-shrink: 0;
        }

        /* å±å¹•å®¹å™¨ */
        .screen {
            display: none; flex-direction: column; flex: 1;
            position: relative; background: var(--bg-color); overflow: hidden;
        }
        .screen.active { display: flex; }

        /* --- 1. å¤‡æˆ˜å¤§å… --- */
        .lobby-content { padding: 20px; overflow-y: auto; padding-bottom: 90px; }
        .card-row { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 20px; }
        .card {
            min-width: 120px; width: 120px;
            background: var(--card-bg); border: 2px solid #30363d;
            border-radius: 8px; cursor: pointer; position: relative; transition: 0.2s;
        }
        .card.selected { border-color: var(--highlight); background: #1f2428; }
        .card img { width: 100%; height: 80px; object-fit: cover; background: #333; }
        .card-info { padding: 8px; font-size: 12px; }
        
        /* æˆ˜ç»©åˆ—è¡¨æ ·å¼ */
        .history-section { border-top: 1px solid #333; margin-top: 20px; padding-top: 20px; }
        .history-list { display: flex; flex-direction: column; gap: 10px; }
        .history-item {
            background: #1c2128; padding: 12px; border-radius: 6px; font-size: 12px;
            display: flex; justify-content: space-between; align-items: center;
            border-left: 3px solid #555;
        }
        .history-item.win { border-left-color: var(--green); }
        .history-item.loss { border-left-color: var(--danger); }
        .h-main { font-weight: bold; font-size: 14px; margin-bottom: 4px; }
        .h-sub { color: #888; }
        .h-val { font-weight: bold; font-family: monospace; font-size: 14px; }

        #checkout-bar {
            position: absolute; bottom: 0; width: 100%; height: 70px;
            background: #111; border-top: 1px solid #333;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; box-sizing: border-box; z-index: 50;
        }
        .btn-main {
            background: var(--highlight); color: #000; border: none;
            padding: 10px 20px; border-radius: 6px; font-weight: bold; font-size: 14px; cursor: pointer;
        }
        .btn-main:active { opacity: 0.8; }

        /* --- å¼¹çª—é€šç”¨ --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 200;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }

        /* ç¡®è®¤å¼¹çª—æ ·å¼ */
        .confirm-box {
            background: #21262d; width: 80%; max-width: 320px;
            border-radius: 12px; border: 1px solid #444; padding: 20px;
            animation: popIn 0.3s;
        }
        .conf-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 14px; }
        .conf-total { border-top: 1px solid #444; padding-top: 12px; font-weight: bold; color: var(--gold); }
        .conf-actions { display: flex; gap: 10px; margin-top: 20px; }
        .btn-cancel { background: transparent; border: 1px solid #444; color: #aaa; flex: 1; padding: 10px; border-radius: 6px; }
        .btn-confirm { background: var(--highlight); color: #000; flex: 1; padding: 10px; border-radius: 6px; font-weight: bold; border: none; }

        /* --- æ¸¸æˆå¯¹è¯æµ --- */
        #game-location-header { background:#111; padding:8px; text-align:center; font-size:12px; border-bottom:1px solid #333; color: #888; }
        #game-log-container { flex: 1; padding: 15px; overflow-y: auto; padding-bottom: 30px; display: flex; flex-direction: column; gap: 12px; }
        .chat-bubble {
            background: #1f2428; padding: 12px; border-radius: 8px 8px 8px 0;
            border-left: 3px solid var(--highlight); max-width: 85%;
            font-size: 14px; line-height: 1.5; animation: slideIn 0.3s ease-out;
        }
        .chat-bubble.event { border-color: var(--gold); background: #221f10; }
        .chat-bubble.system { background: transparent; border: none; color: #666; font-size: 12px; text-align: center; margin: 0 auto; }
        .choice-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 5px; animation: fadeIn 0.5s; }
        .chat-btn {
            background: rgba(88,166,255,0.1); border: 1px solid var(--highlight); color: var(--highlight);
            padding: 8px 15px; border-radius: 20px; font-size: 13px; cursor: pointer;
        }
        
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* --- æˆ˜æ–—ç•Œé¢ --- */
        #screen-combat {
            background: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.85)),
                        url('https://p6.music.126.net/obj/wonDlsKUwrLClGjCm8Kx/77918735759/1a75/b634/30fd/7b268bc5aca0d86a8f7e5ced4f735e35.png');
            background-size: cover; background-position: center; background-repeat: no-repeat; z-index: 100;
        }
        .combat-stage { flex: 1; display: flex; flex-direction: column; justify-content: space-between; padding: 40px 30px; position: relative; }
        .fighter-wrapper { display: flex; align-items: center; gap: 15px; position: relative; }
        .fighter-wrapper.enemy { flex-direction: row-reverse; align-self: flex-end; }
        .fighter-avatar {
            width: 70px; height: 70px; border-radius: 50%; border: 3px solid #555;
            background: #222; object-fit: cover; box-shadow: 0 0 15px rgba(0,0,0,0.8);
            position: relative; z-index: 2;
        }
        .fighter-wrapper.enemy .fighter-avatar { border-color: var(--danger); }
        .fighter-wrapper.player .fighter-avatar { border-color: var(--highlight); }
        .fighter-info { display: flex; flex-direction: column; min-width: 100px; }
        .fighter-wrapper.enemy .fighter-info { text-align: right; align-items: flex-end; }
        .hp-bar-bg { width: 100%; height: 8px; background: rgba(0,0,0,0.5); border:1px solid #444; border-radius: 4px; margin-top: 5px; overflow: hidden; }
        .hp-bar-fill { height: 100%; background: var(--green); transition: width 0.3s; }
        .fighter-wrapper.enemy .hp-bar-fill { background: var(--danger); }
        .combat-log-area {
            height: 140px; background: rgba(0,0,0,0.7); border-top: 1px solid #333;
            padding: 15px; font-family: monospace; font-size: 13px; color: #ccc;
            overflow-y: auto; flex-shrink: 0; backdrop-filter: blur(5px);
        }
        /* æˆ˜æ–—åŠ¨æ•ˆ */
        .dmg-popup {
            position: absolute; top: 0; left: 50%; transform: translateX(-50%);
            color: #ff3333; font-size: 24px; font-weight: 900;
            text-shadow: 2px 2px 0 #000; pointer-events: none; z-index: 10;
            animation: floatUp 1s ease-out forwards;
        }
        @keyframes floatUp { 0% { opacity: 1; top: 0; transform: translateX(-50%) scale(0.5); } 50% { transform: translateX(-50%) scale(1.5); } 100% { opacity: 0; top: -50px; transform: translateX(-50%) scale(1); } }
        .shake-anim { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-2px, 0, 0); } 20%, 80% { transform: translate3d(4px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-6px, 0, 0); } 40%, 60% { transform: translate3d(6px, 0, 0); } }
        .hit-flash { animation: flashRed 0.3s; }
        @keyframes flashRed { 0% { filter: brightness(1); } 50% { filter: brightness(3) sepia(1) hue-rotate(-50deg) saturate(5); } 100% { filter: brightness(1); } }
        .atk-lunge-right { animation: lungeRight 0.3s; }
        @keyframes lungeRight { 0% { transform: translateX(0); } 50% { transform: translateX(30px); } 100% { transform: translateX(0); } }
        .atk-lunge-left { animation: lungeLeft 0.3s; }
        @keyframes lungeLeft { 0% { transform: translateX(0); } 50% { transform: translateX(-30px); } 100% { transform: translateX(0); } }

        /* --- æœåˆ®å¼¹çª— --- */
        .magnify-glass { font-size: 60px; animation: scanCircle 1.2s linear infinite; margin-bottom: 20px; }
        @keyframes scanCircle { from { transform: rotate(0deg) translateX(20px) rotate(0deg); } to { transform: rotate(360deg) translateX(20px) rotate(-360deg); } }
        .loot-card {
            display: none; background: #21262d; padding: 25px; border-radius: 12px;
            text-align: center; border: 2px solid #444; width: 220px; animation: popIn 0.4s;
        }

    </style>
</head>
<body>

    <div id="status-bar">
        <div>ğŸª™ <span id="ui-money">0</span></div>
        <div>â¤ï¸ <span id="ui-hp-global">100%</span></div>
        <div>ğŸ’ <span id="ui-bag">0</span></div>
    </div>

    <!-- 1. å¤‡æˆ˜ -->
    <div id="screen-lobby" class="screen active">
        <div class="lobby-content">
            <h4 style="color:var(--highlight); margin:10px 0;">é€‰æ‹©å¹²å‘˜</h4>
            <div class="card-row" id="char-list"></div>
            
            <h4 style="color:var(--highlight); margin:10px 0;">é…å¤‡æ­¦å™¨</h4>
            <div class="card-row" id="weapon-list"></div>

            <h4 style="color:var(--highlight); margin:10px 0;">é˜²æŠ¤ç­‰çº§</h4>
            <div style="background:#21262d; padding:15px; border-radius:8px; border:1px solid #333;">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <span id="armor-name">æ— é˜²å…·</span>
                    <span id="cost-preview" style="color:var(--gold)">$0</span>
                </div>
                <input type="range" id="armor-slider" min="0" max="3" value="0" style="width:100%; accent-color:var(--highlight)">
            </div>

            <!-- ä½œæˆ˜è®°å½• -->
            <div class="history-section">
                <h4 style="color:#aaa; margin-bottom:15px; border-left:3px solid #555; padding-left:10px;">è¡ŒåŠ¨è®°å½•</h4>
                <div class="history-list" id="history-container">
                    <div style="text-align:center; color:#555; padding:20px;">æš‚æ— æ•°æ®</div>
                </div>
            </div>
        </div>
        <div id="checkout-bar">
            <span style="color:#666; font-size:12px">å‡†å¤‡è¡ŒåŠ¨?</span>
            <!-- è§¦å‘ç¡®è®¤å¼¹çª—ï¼Œè€Œä¸æ˜¯ç›´æ¥å¼€å§‹ -->
            <button class="btn-main" onclick="UI.showConfirmModal()">å¼€å§‹è¡ŒåŠ¨</button>
        </div>
    </div>

    <!-- 2. æ¸¸æˆå†… -->
    <div id="screen-game" class="screen">
        <div id="game-location-header">ğŸ“ <span id="ui-loc">éƒ¨ç½²ä¸­...</span></div>
        <div id="game-log-container"></div>
    </div>

    <!-- 3. æˆ˜æ–— -->
    <div id="screen-combat" class="screen">
        <div class="combat-stage">
            <div class="fighter-wrapper enemy" id="fighter-enemy">
                <img id="enemy-img" class="fighter-avatar" src="">
                <div class="fighter-info">
                    <div id="enemy-name" style="font-weight:bold; color:var(--danger)">æ•Œäºº</div>
                    <div class="hp-bar-bg"><div class="hp-bar-fill" id="enemy-hp-bar" style="width:100%"></div></div>
                    <div id="enemy-hp-text" style="font-size:10px; color:#fff; text-shadow:0 0 2px #000">100/100</div>
                </div>
            </div>
            <div class="fighter-wrapper player" id="fighter-player">
                <img id="player-img" class="fighter-avatar" src="">
                <div class="fighter-info">
                    <div id="player-name" style="font-weight:bold; color:var(--highlight)">æˆ‘æ–¹</div>
                    <div class="hp-bar-bg"><div class="hp-bar-fill" id="player-hp-bar" style="width:100%"></div></div>
                    <div id="player-hp-text" style="font-size:10px; color:#fff; text-shadow:0 0 2px #000">100/100</div>
                </div>
            </div>
        </div>
        <div class="combat-log-area" id="combat-log"></div>
    </div>

    <!-- å¼¹çª—ï¼šæœåˆ® -->
    <div id="modal-loot" class="modal-overlay">
        <div id="loot-anim" style="text-align:center">
            <div class="magnify-glass">ğŸ”</div>
            <div style="color:#aaa; margin-top:10px;">æ­£åœ¨æœç´¢ç‰©èµ„...</div>
        </div>
        <div id="loot-result" class="loot-card">
            <img id="loot-item-img" style="width:80px; height:80px; object-fit:contain; margin-bottom:10px;" src="">
            <div id="loot-item-name" style="font-size:16px; font-weight:bold; margin-bottom:5px; color:#fff">ç‰©å“å</div>
            <div id="loot-item-val" style="color:var(--gold); margin-bottom:15px; font-weight:bold">$0</div>
            <button class="btn-main" onclick="Game.closeLootModal()" style="width:100%">æ”¶ä¸‹</button>
        </div>
    </div>

    <!-- å¼¹çª—ï¼šå‡ºå‡»ç¡®è®¤ -->
    <div id="modal-confirm" class="modal-overlay">
        <div class="confirm-box">
            <h3 style="margin-top:0; color:var(--text-main); text-align:center;">è¡ŒåŠ¨ç¡®è®¤</h3>
            
            <div class="conf-row">
                <span style="color:#888">å½“å‰èµ„é‡‘:</span>
                <span id="conf-balance" style="font-family:monospace">$0</span>
            </div>
            <div class="conf-row">
                <span style="color:#888">è£…å¤‡èŠ±è´¹:</span>
                <span id="conf-cost" style="color:var(--danger); font-family:monospace">-$0</span>
            </div>
            <div class="conf-row conf-total">
                <span>é¢„è®¡å‰©ä½™:</span>
                <span id="conf-remain" style="font-family:monospace">$0</span>
            </div>

            <div class="conf-actions">
                <button class="btn-cancel" onclick="document.getElementById('modal-confirm').style.display='none'">å–æ¶ˆ</button>
                <button class="btn-confirm" onclick="Game.finalStart()">ç¡®è®¤æ”¯ä»˜</button>
            </div>
        </div>
    </div>

<script>
// --- æ•°æ®é…ç½® ---
const DATA = {
    chars: [
        { id: 0, name: 'å¨é¾™', role: 'çªå‡»', stats: {atk: 12, hp: 140}, img: 'https://placehold.co/100/222/FFF?text=å¨é¾™' },
        { id: 1, name: 'èœ‚åŒ»', role: 'æ”¯æ´', stats: {atk: 8, hp: 180}, img: 'https://placehold.co/100/222/FFF?text=èœ‚åŒ»' },
        { id: 2, name: 'çº¢ç‹¼', role: 'ä¾¦æŸ¥', stats: {atk: 10, hp: 120}, img: 'https://placehold.co/100/222/FFF?text=çº¢ç‹¼' }
    ],
    weapons: [
        { id: 0, name: 'æˆ˜æœ¯åŒ•é¦–', cost: 0, atk: 10, img: 'https://placehold.co/100/333/FFF?text=åŒ•é¦–' },
        { id: 1, name: 'MP5å†²é”‹æª', cost: 20000, atk: 25, img: 'https://placehold.co/100/333/FFF?text=MP5' },
        { id: 2, name: 'M4A1æ­¥æª', cost: 50000, atk: 45, img: 'https://placehold.co/100/333/FFF?text=M4A1' }
    ],
    armor: [
        { name: 'æ— é˜²å…·', cost: 0, hp: 0 },
        { name: 'ä¸€çº§ç”²', cost: 20000, hp: 50 },
        { name: 'ä¸‰çº§ç”²', cost: 50000, hp: 100 },
        { name: 'äº”çº§ç”²', cost: 100000, hp: 200 }
    ],
    enemies: [
        { name: 'æ¸¸è¡è€…', hp: 80, atk: 12, img: 'https://placehold.co/100/511/FFF?text=AI' },
        { name: 'å…¨è£…ç‰¹é£', hp: 160, atk: 30, img: 'https://placehold.co/100/811/FFF?text=Enemy' },
        { name: 'é¦–é¢†é˜¿è¨æ‹‰', hp: 400, atk: 45, img: 'https://placehold.co/100/800/FFF?text=BOSS' }
    ],
    loot: [
        { name: 'æ‰“ç«æœº', val: 1000, tier: 1, img: 'https://placehold.co/120/333/FFF?text=æ‰“ç«æœº' },
        { name: 'CPUé£æ‰‡', val: 5000, tier: 2, img: 'https://placehold.co/120/4a90e2/FFF?text=CPU' },
        { name: 'é‡‘ç –', val: 50000, tier: 3, img: 'https://placehold.co/120/ffd700/000?text=é‡‘ç –' },
        { name: 'æœºå¯†æ–‡ä»¶', val: 800000, tier: 4, img: 'https://placehold.co/120/ff0000/FFF?text=æœºå¯†æ–‡ä»¶' }
    ]
};

const State = {
    money: 300000,
    sel: { char: 0, weap: 0, armor: 0 },
    game: { curHp: 0, maxHp: 0, atk: 0, bagVal: 0, bag: [] },
    combat: null
};

// --- ä½œæˆ˜è®°å½•ç³»ç»Ÿ (Local Storage) ---
const RecordSystem = {
    key: 'delta_game_records',
    add: (charName, result, profit) => {
        const rec = {
            char: charName,
            res: result, // 'win' or 'loss'
            profit: profit,
            time: new Date().toLocaleTimeString()
        };
        const list = RecordSystem.get();
        list.unshift(rec); // æ–°çš„åœ¨å‰é¢
        if(list.length > 10) list.pop(); // åªç•™10æ¡
        localStorage.setItem(RecordSystem.key, JSON.stringify(list));
        UI.renderHistory();
    },
    get: () => {
        const s = localStorage.getItem(RecordSystem.key);
        return s ? JSON.parse(s) : [];
    }
};

// --- UI æ§åˆ¶ ---
const UI = {
    init: () => {
        document.getElementById('char-list').innerHTML = DATA.chars.map((c,i) => `
            <div class="card ${i===0?'selected':''}" onclick="UI.selChar(${i}, this)">
                <img src="${c.img}">
                <div class="card-info"><b>${c.name}</b><br>æ”»:${c.stats.atk} è¡€:${c.stats.hp}</div>
            </div>
        `).join('');
        document.getElementById('weapon-list').innerHTML = DATA.weapons.map((w,i) => `
            <div class="card ${i===0?'selected':''}" onclick="UI.selWeap(${i}, this)">
                <img src="${w.img}">
                <div class="card-info"><b>${w.name}</b><br>$${w.cost}</div>
            </div>
        `).join('');
        document.getElementById('armor-slider').oninput = function() {
            State.sel.armor = parseInt(this.value);
            UI.updateLobby();
        };
        UI.updateLobby();
        UI.renderHistory(); // åŠ è½½å†å²
    },

    renderHistory: () => {
        const list = RecordSystem.get();
        const con = document.getElementById('history-container');
        if(list.length === 0) {
            con.innerHTML = '<div style="text-align:center; color:#555; padding:20px;">æš‚æ— æ•°æ®</div>';
            return;
        }
        con.innerHTML = list.map(r => `
            <div class="history-item ${r.res}">
                <div>
                    <div class="h-main">${r.res==='win'?'æ’¤ç¦»æˆåŠŸ':'è¡ŒåŠ¨é˜µäº¡'} <span class="h-sub">(${r.char})</span></div>
                    <div class="h-sub">${r.time}</div>
                </div>
                <div class="h-val" style="color:${r.profit>=0?'#e3b341':'#ff6b6b'}">
                    ${r.profit>=0?'+':''}${r.profit}
                </div>
            </div>
        `).join('');
    },

    selChar: (i, el) => { State.sel.char = i; UI.hl(el); UI.updateLobby(); },
    selWeap: (i, el) => { State.sel.weap = i; UI.hl(el); UI.updateLobby(); },
    hl: (el) => {
        el.parentElement.querySelectorAll('.card').forEach(c=>c.classList.remove('selected'));
        el.classList.add('selected');
    },
    updateLobby: () => {
        const armor = DATA.armor[State.sel.armor];
        const cost = DATA.weapons[State.sel.weap].cost + armor.cost;
        document.getElementById('ui-money').innerText = State.money;
        document.getElementById('armor-name').innerText = armor.name;
        document.getElementById('cost-preview').innerText = `$${cost}`;
    },
    
    // å¼¹çª—é€»è¾‘
    showConfirmModal: () => {
        const cost = DATA.weapons[State.sel.weap].cost + DATA.armor[State.sel.armor].cost;
        if(State.money < cost) return alert("èµ„é‡‘ä¸è¶³ï¼");

        document.getElementById('conf-balance').innerText = `$${State.money}`;
        document.getElementById('conf-cost').innerText = `-$${cost}`;
        document.getElementById('conf-remain').innerText = `$${State.money - cost}`;
        document.getElementById('modal-confirm').style.display = 'flex';
    },

    showScreen: (id) => {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    },
    chat: (text, type='normal') => {
        const c = document.getElementById('game-log-container');
        const d = document.createElement('div');
        d.className = `chat-bubble ${type}`;
        d.innerHTML = text;
        c.appendChild(d);
        c.scrollTop = c.scrollHeight;
    },
    ask: (opts) => {
        const c = document.getElementById('game-log-container');
        const div = document.createElement('div');
        div.className = 'choice-container';
        opts.forEach(o => {
            const b = document.createElement('button');
            b.className = 'chat-btn';
            b.innerText = o.txt;
            b.onclick = () => { div.remove(); UI.chat(`> ${o.txt}`, 'system'); o.cb(); };
            div.appendChild(b);
        });
        c.appendChild(div);
        c.scrollTop = c.scrollHeight;
    }
};

// --- æ¸¸æˆé€»è¾‘ ---
const Game = {
    finalStart: () => {
        document.getElementById('modal-confirm').style.display = 'none';
        const cost = DATA.weapons[State.sel.weap].cost + DATA.armor[State.sel.armor].cost;
        State.money -= cost;
        State.game.currentCost = cost; // è®°å½•æˆæœ¬ç”¨äºè®¡ç®—å‡€åˆ©æ¶¦
        
        const c = DATA.chars[State.sel.char];
        const w = DATA.weapons[State.sel.weap];
        const a = DATA.armor[State.sel.armor];
        State.game = {
            ...State.game,
            curHp: c.stats.hp + a.hp,
            maxHp: c.stats.hp + a.hp,
            atk: c.stats.atk + w.atk,
            bagVal: 0, bag: [],
            currentCost: cost // è®°å½•æœ¬å±€æŠ•å…¥
        };
        
        UI.showScreen('screen-game');
        document.getElementById('game-log-container').innerHTML = '';
        document.getElementById('ui-hp-global').innerText = '100%';
        document.getElementById('ui-bag').innerText = '0';
        Game.flow('START');
    },

    flow: (step) => {
        if(step === 'START') {
            document.getElementById('ui-loc').innerText = "é›¶å·å¤§åÂ·å¤–å›´";
            UI.chat("ä½ å·²æŠµè¾¾å¤§åå¤–å›´ï¼Œç©ºæ°”ä¸­å¼¥æ¼«ç€ç¡çƒŸã€‚", 'event');
            setTimeout(() => {
                UI.chat("ä¾¦æµ‹åˆ°ä¸¤ä¸ªä¿¡å·æºï¼Œè¯·æŒ‡ç¤ºã€‚");
                UI.ask([
                    { txt: "å‰å¾€è¡Œæ”¿æ¥¼ (é«˜é£é™©)", cb: ()=>Game.flow('ADMIN') },
                    { txt: "æœæŸ¥æ¸¸å®¢ä¸­å¿ƒ (ä¸€èˆ¬)", cb: ()=>Game.flow('VISITOR') }
                ]);
            }, 600);
        }
        else if(step === 'ADMIN') {
            document.getElementById('ui-loc').innerText = "è¡Œæ”¿æ¥¼";
            UI.chat("è¡Œæ”¿æ¥¼å†…éƒ¨å…‰çº¿æ˜æš—...", 'event');
            if(Math.random() < 0.8) {
                UI.chat("å‰æ–¹å‘ç°å…¨è£…æ•Œäººï¼å‡†å¤‡äº¤æˆ˜ï¼", 'system');
                setTimeout(() => Game.initCombat('hard'), 1000);
            } else {
                UI.chat("è¿™é‡Œæœ‰ä¸ªé«˜çº§ä¿é™©ç®±ã€‚");
                UI.ask([{ txt: "å¼€å¯ä¿é™©ç®±", cb: ()=>Game.loot(3) }]);
            }
        }
        else if(step === 'VISITOR') {
            document.getElementById('ui-loc').innerText = "æ¸¸å®¢ä¸­å¿ƒ";
            UI.chat("è¿™é‡Œçœ‹èµ·æ¥è¢«æœåˆ®è¿‡äº†ã€‚", 'event');
            if(Math.random() < 0.4) {
                UI.chat("æœ‰ä¸ªæ¸¸è¡è€…åœ¨è§’è½ã€‚", 'system');
                setTimeout(() => Game.initCombat('easy'), 1000);
            } else {
                UI.chat("å‘ç°ä¸€ä¸ªé—è½çš„èƒŒåŒ…ã€‚");
                UI.ask([{ txt: "æ£€æŸ¥èƒŒåŒ…", cb: ()=>Game.loot(1) }]);
            }
        }
        else if(step === 'AFTER') {
            UI.chat("åŒºåŸŸå®‰å…¨ã€‚ä¸‹ä¸€æ­¥ï¼Ÿ");
            UI.ask([
                { txt: "ç»§ç»­æ¢ç´¢", cb: ()=>Game.flow(Math.random()>0.5?'ADMIN':'VISITOR') },
                { txt: "æ’¤ç¦»", cb: ()=>Game.extract() }
            ]);
        }
    },

    loot: (tier) => {
        const m = document.getElementById('modal-loot');
        m.style.display = 'flex';
        document.getElementById('loot-anim').style.display = 'block';
        document.getElementById('loot-result').style.display = 'none';
        
        const roll = Math.random() * 100 + (tier*10);
        let item = DATA.loot[0];
        let wait = 1000;
        if(roll > 95) { item = DATA.loot[3]; wait = 3000; }
        else if(roll > 75) { item = DATA.loot[2]; wait = 2000; }
        else if(roll > 40) { item = DATA.loot[1]; wait = 1500; }
        
        setTimeout(() => {
            document.getElementById('loot-anim').style.display = 'none';
            document.getElementById('loot-result').style.display = 'block';
            document.getElementById('loot-item-img').src = item.img;
            document.getElementById('loot-item-name').innerText = item.name;
            document.getElementById('loot-item-name').style.color = item.tier>=3 ? 'gold' : 'white';
            document.getElementById('loot-item-val').innerText = `$${item.val}`;
            Game.tempItem = item;
        }, wait);
    },
    
    closeLootModal: () => {
        document.getElementById('modal-loot').style.display = 'none';
        State.game.bag.push(Game.tempItem);
        State.game.bagVal += Game.tempItem.val;
        document.getElementById('ui-bag').innerText = State.game.bagVal;
        UI.chat(`è·å¾— <span style="color:gold">${Game.tempItem.name}</span>`, 'system');
        Game.flow('AFTER');
    },

    initCombat: (diff) => {
        UI.showScreen('screen-combat');
        let enemy = DATA.enemies[0];
        if(diff === 'hard') enemy = DATA.enemies[1];
        if(diff === 'boss') enemy = DATA.enemies[2];
        State.combat = { round: 0, enemy: { ...enemy, maxHp: enemy.hp }, player: State.game };
        
        document.getElementById('combat-log').innerHTML = '<div style="color:#aaa">>>> æˆ˜æ–—ç³»ç»Ÿå¯åŠ¨ <<<</div>';
        document.getElementById('enemy-img').src = enemy.img;
        document.getElementById('enemy-name').innerText = enemy.name;
        document.getElementById('player-img').src = DATA.chars[State.sel.char].img;
        
        Game.updateCombatBars();
        setTimeout(Game.turnPlayer, 1000);
    },

    updateCombatBars: () => {
        const c = State.combat;
        const ep = (c.enemy.hp / c.enemy.maxHp) * 100;
        document.getElementById('enemy-hp-bar').style.width = Math.max(0, ep) + '%';
        document.getElementById('enemy-hp-text').innerText = `${c.enemy.hp}/${c.enemy.maxHp}`;
        
        const pp = (c.player.curHp / c.player.maxHp) * 100;
        document.getElementById('player-hp-bar').style.width = Math.max(0, pp) + '%';
        document.getElementById('player-hp-text').innerText = `${c.player.curHp}/${c.player.maxHp}`;
        document.getElementById('ui-hp-global').innerText = Math.floor(pp) + '%';
    },

    showDmg: (targetId, dmg) => {
        const wrapper = document.getElementById(targetId);
        const el = document.createElement('div');
        el.className = 'dmg-popup';
        el.innerText = `-${dmg}`;
        wrapper.appendChild(el);
        setTimeout(()=>el.remove(), 1000);
        const img = wrapper.querySelector('img');
        img.classList.add('shake-anim', 'hit-flash');
        setTimeout(() => img.classList.remove('shake-anim', 'hit-flash'), 400);
    },

    turnPlayer: () => {
        if(State.combat.player.curHp <= 0) return Game.endCombat(false);
        document.getElementById('player-img').classList.add('atk-lunge-right');
        setTimeout(() => document.getElementById('player-img').classList.remove('atk-lunge-right'), 300);

        const dmg = Math.floor(State.combat.player.atk * (0.9 + Math.random()*0.3));
        State.combat.enemy.hp -= dmg;
        if(State.combat.enemy.hp < 0) State.combat.enemy.hp = 0;
        
        setTimeout(() => {
            Game.showDmg('fighter-enemy', dmg);
            Game.updateCombatBars();
            Game.logCombat(`ä½ å°„å‡»é€ æˆ <span style="color:#ff6b6b">${dmg}</span> ä¼¤å®³`);
            if(State.combat.enemy.hp <= 0) {
                setTimeout(() => Game.endCombat(true), 1200);
            } else {
                setTimeout(Game.turnEnemy, 1500);
            }
        }, 300);
    },

    turnEnemy: () => {
        if(State.combat.enemy.hp <= 0) return;
        document.getElementById('enemy-img').classList.add('atk-lunge-left');
        setTimeout(() => document.getElementById('enemy-img').classList.remove('atk-lunge-left'), 300);

        const dmg = Math.floor(State.combat.enemy.atk * (0.8 + Math.random()*0.4));
        State.combat.player.curHp -= dmg;
        if(State.combat.player.curHp < 0) State.combat.player.curHp = 0;

        setTimeout(() => {
            Game.showDmg('fighter-player', dmg);
            Game.updateCombatBars();
            Game.logCombat(`${State.combat.enemy.name} åå‡»é€ æˆ <span style="color:#ff6b6b">${dmg}</span> ä¼¤å®³`);
            if(State.combat.player.curHp <= 0) {
                setTimeout(() => Game.endCombat(false), 1200);
            } else {
                setTimeout(Game.turnPlayer, 1500);
            }
        }, 300);
    },

    logCombat: (msg) => {
        const d = document.createElement('div');
        d.innerHTML = `> ${msg}`;
        const box = document.getElementById('combat-log');
        box.appendChild(d);
        box.scrollTop = box.scrollHeight;
    },

    endCombat: (win) => {
        if(win) {
            const loot = State.combat.enemy.atk * 800;
            State.game.bagVal += loot;
            document.getElementById('ui-bag').innerText = State.game.bagVal;
            alert(`æˆ˜æ–—èƒœåˆ©ï¼\nç¼´è·ç‰©èµ„ä»·å€¼: $${loot}`);
            UI.showScreen('screen-game');
            UI.chat("å¨èƒå·²æ¸…é™¤ã€‚ç»§ç»­è¡ŒåŠ¨ã€‚", 'event');
            Game.flow('AFTER');
        } else {
            alert("ä½ å·²é˜µäº¡...");
            // è®°å½•æˆ˜è´¥
            RecordSystem.add(DATA.chars[State.sel.char].name, 'loss', -State.game.currentCost);
            location.reload();
        }
    },

    extract: () => {
        UI.chat("å‘¼å«æ’¤ç¦»...", 'event');
        setTimeout(() => {
            const profit = State.game.bagVal;
            const netProfit = profit; // å‡€åˆ©æ¶¦ä¸å‡è£…å¤‡è´¹(å› ä¸ºè£…å¤‡ä¿ç•™)ï¼Œæˆ–è€…å‡å»ç»´ä¿®è´¹? ç®€åŒ–èµ·è§ï¼Œè¿™é‡Œè®°å½•å¸¦å‡ºçš„é’±
            
            alert(`æˆåŠŸæ’¤ç¦»ï¼\nå¸¦å‡ºæ”¶ç›Š: $${profit}`);
            State.money += profit;
            
            // è®°å½•èƒœåˆ©
            RecordSystem.add(DATA.chars[State.sel.char].name, 'win', profit);
            
            UI.showScreen('screen-lobby');
            UI.updateLobby();
        }, 1500);
    }
};

UI.init();
</script>
</body>
</html>
