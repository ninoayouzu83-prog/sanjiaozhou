<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ–‡å­—ä¸‰è§’æ´² V7.2ï¼šæ»¡æ”¹M7</title>
    <style>
        :root {
            --bg-color: #0d1117;
            --panel-bg: #161b22;
            --card-bg: #21262d;
            --text-main: #e6edf3;
            --highlight: #58a6ff;
            --danger: #ff4444; 
            --gold: #ffd700;
            --purple: #d2a8ff;
            --green: #3fb950;
            --dark-red: #8b0000;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, monospace;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0; padding: 0; height: 100vh;
            display: flex; flex-direction: column; overflow: hidden; user-select: none;
        }

        /* é¡¶éƒ¨çŠ¶æ€æ  */
        #status-bar {
            height: 40px; background-color: #010409; padding: 0 15px;
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid #30363d; z-index: 20; font-size: 13px; flex-shrink: 0;
        }

        /* å±å¹•å®¹å™¨ */
        .screen { display: none; flex-direction: column; flex: 1; position: relative; background: var(--bg-color); overflow: hidden; }
        .screen.active { display: flex; }

        /* --- 1. å¤‡æˆ˜å¤§å… --- */
        .lobby-content { padding: 20px; overflow-y: auto; padding-bottom: 90px; }
        .section-title { color: var(--highlight); margin: 15px 0 10px 0; font-size: 14px; border-left: 3px solid var(--highlight); padding-left: 8px; font-weight: bold; }
        
        .exhibition-entry {
            background: linear-gradient(135deg, #3a1111, #1a0505);
            border: 1px solid var(--danger);
            border-radius: 8px; padding: 15px;
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; cursor: pointer;
            box-shadow: 0 4px 10px rgba(255, 68, 68, 0.2);
        }
        .exhibition-entry:active { opacity: 0.8; }

        .card-row { display: flex; gap: 12px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 10px; scrollbar-width: none; }
        .card-row::-webkit-scrollbar { display: none; }
        
        .card {
            min-width: 130px; width: 130px;
            background: var(--card-bg); border: 2px solid #30363d;
            border-radius: 8px; cursor: pointer; position: relative; transition: 0.2s; overflow: hidden;
        }
        .card.selected { border-color: var(--highlight); background: #1f2428; box-shadow: 0 0 10px rgba(88,166,255,0.2); }
        .card img { width: 100%; height: 70px; object-fit: cover; background: #333; }
        .card-info { padding: 10px; font-size: 12px; line-height: 1.6; }
        
        .stat-badge { 
            display: inline-block; background: rgba(0,0,0,0.3); 
            padding: 2px 6px; border-radius: 4px; margin-top: 4px; margin-right: 4px;
            font-weight: bold; font-family: monospace; font-size: 11px;
        }
        
        /* åº•éƒ¨ç»“ç®—æ  */
        #checkout-bar {
            position: absolute; bottom: 0; width: 100%; height: 70px;
            background: #0d1117; border-top: 1px solid #30363d;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; box-sizing: border-box; z-index: 50;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
        }
        .bill-display { display: flex; flex-direction: column; }
        .bill-total { font-size: 16px; color: var(--gold); font-weight: bold; font-family: monospace; }
        .btn-main { background: var(--highlight); color: #000; border: none; padding: 12px 24px; border-radius: 6px; font-weight: bold; font-size: 15px; cursor: pointer; }

        /* --- å±•è§ˆé¦†æ ·å¼ --- */
        #modal-exhibition { background: #110505; align-items: flex-start; padding-top: 40px; overflow-y: auto; }
        .exhibition-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 15px; width: 100%; box-sizing: border-box; }
        .museum-card { background: #1a0505; border: 1px solid #331111; border-radius: 6px; text-align: center; padding: 10px 5px; opacity: 0.4; filter: grayscale(1); transition: 0.3s; }
        .museum-card.unlocked { opacity: 1; filter: grayscale(0); border-color: var(--danger); background: linear-gradient(180deg, #2a0a0a, #441111); transform: scale(1.02); box-shadow: 0 0 8px var(--danger); }
        .museum-img { width: 100%; height: 50px; object-fit: contain; margin-bottom: 5px; }
        .museum-name { font-size: 10px; color: #aaa; margin-bottom: 2px; }
        .museum-count { font-size: 10px; color: var(--gold); font-weight: bold; }

        /* --- å¼¹çª—é€šç”¨ --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 200;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        .btn-close-modal {
            position: absolute; top: 20px; right: 20px;
            background: #333; color: white; border: none; padding: 8px 15px; border-radius: 20px;
            cursor: pointer; z-index: 210;
        }

        /* ç¡®è®¤å¼¹çª— */
        .confirm-box { background: #21262d; width: 85%; max-width: 320px; border-radius: 12px; border: 1px solid #444; padding: 25px; animation: popIn 0.3s; }
        .conf-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 14px; }
        
        /* --- æ¸¸æˆå†… --- */
        #game-log-container { flex: 1; padding: 15px; overflow-y: auto; padding-bottom: 30px; display: flex; flex-direction: column; gap: 12px; }
        .chat-bubble {
            background: #1f2428; padding: 12px; border-radius: 8px 8px 8px 0; border-left: 3px solid var(--highlight); max-width: 85%; font-size: 14px; line-height: 1.5; animation: slideIn 0.3s;
        }
        .chat-bubble.event { border-color: var(--gold); background: #221f10; }
        .chat-bubble.system { background: transparent; border: none; color: #666; font-size: 12px; text-align: center; margin: 0 auto; }
        .choice-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 5px; animation: fadeIn 0.5s; }
        .chat-btn { background: rgba(88,166,255,0.1); border: 1px solid var(--highlight); color: var(--highlight); padding: 8px 15px; border-radius: 20px; font-size: 13px; cursor: pointer; }
        
        /* æˆ˜æ–— */
        #screen-combat { background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.85)), url('https://p6.music.126.net/obj/wonDlsKUwrLClGjCm8Kx/77918735759/1a75/b634/30fd/7b268bc5aca0d86a8f7e5ced4f735e35.png'); background-size: cover; background-position: center; }
        .combat-stage { flex: 1; display: flex; flex-direction: column; justify-content: space-between; padding: 40px 30px; }
        .fighter-wrapper { display: flex; align-items: center; gap: 15px; position: relative; }
        .fighter-wrapper.enemy { flex-direction: row-reverse; align-self: flex-end; }
        
        .fighter-avatar { width: 70px; height: 70px; border-radius: 50%; border: 3px solid #555; background: #222; box-shadow: 0 0 15px rgba(0,0,0,0.8); z-index: 2; }
        .fighter-wrapper.enemy .fighter-avatar { border-color: var(--danger); }
        .fighter-wrapper.player .fighter-avatar { border-color: var(--highlight); }
        
        .fighter-info { display: flex; flex-direction: column; min-width: 100px; text-shadow:0 0 2px #000; }
        .fighter-wrapper.enemy .fighter-info { text-align: right; align-items: flex-end; }
        
        .hp-bar-bg { width: 100%; height: 8px; background: rgba(0,0,0,0.5); border:1px solid #444; border-radius: 4px; margin-top: 5px; overflow: hidden; }
        .hp-bar-fill { height: 100%; background: var(--green); transition: width 0.3s; }
        .fighter-wrapper.enemy .hp-bar-fill { background: var(--danger); }
        
        .combat-log-area { height: 140px; background: rgba(0,0,0,0.7); border-top: 1px solid #333; padding: 15px; font-family: monospace; font-size: 13px; color: #ccc; overflow-y: auto; }
        
        /* åŠ¨ç”» */
        .dmg-popup { 
            position: absolute; top: -10px; left: 50%; transform: translateX(-50%); 
            color: #ff3333; font-size: 24px; font-weight: 900; text-shadow: 1px 1px 0 #000;
            animation: floatUp 0.8s ease-out forwards; z-index: 10; 
        }
        @keyframes floatUp { 0% { opacity: 1; top: -10px; transform: translateX(-50%) scale(0.8); } 50% { transform: translateX(-50%) scale(1.5); } 100% { opacity: 0; top: -60px; transform: translateX(-50%) scale(1); } }
        
        .shake-anim { animation: shake 0.4s both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-2px, 0, 0); } 40%, 60% { transform: translate3d(6px, 0, 0); } }
        .hit-flash { animation: flashRed 0.3s; }
        @keyframes flashRed { 50% { filter: brightness(3) sepia(1) hue-rotate(-50deg) saturate(5); } }
        .atk-lunge-right { animation: lungeRight 0.3s; }
        @keyframes lungeRight { 50% { transform: translateX(30px); } }
        .atk-lunge-left { animation: lungeLeft 0.3s; }
        @keyframes lungeLeft { 50% { transform: translateX(-30px); } }
        
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* æœåˆ®åŠ¨ç”» */
        .magnify-glass { font-size: 60px; animation: scanCircle 1.2s linear infinite; margin-bottom: 20px; }
        @keyframes scanCircle { from { transform: rotate(0deg) translateX(20px) rotate(0deg); } to { transform: rotate(360deg) translateX(20px) rotate(-360deg); } }
        
        .loot-card {
            display: none; background: #21262d; padding: 25px; border-radius: 12px;
            text-align: center; border: 2px solid #444; width: 220px; animation: popIn 0.4s;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>

    <div id="status-bar">
        <div>ğŸª™ <span id="ui-money">0</span></div>
        <div>â¤ï¸ <span id="ui-hp-global">100%</span></div>
        <div>ğŸ’ <span id="ui-bag">0</span></div>
    </div>

    <!-- 1. å¤‡æˆ˜å¤§å… -->
    <div id="screen-lobby" class="screen active">
        <div class="lobby-content">
            <div class="exhibition-entry" onclick="UI.showExhibition()">
                <div>
                    <div style="font-weight:bold; color:var(--danger); font-size:16px;">ğŸ† å¤§çº¢å±•è§ˆé¦†</div>
                    <div style="font-size:10px; color:#aaa; margin-top:4px;">æŸ¥çœ‹æ’¤ç¦»å¸¦å‡ºçš„é¡¶çº§è—å“</div>
                </div>
                <div style="font-size:24px;">ğŸ›ï¸</div>
            </div>

            <div class="section-title">ç‰¹å‹¤å¹²å‘˜</div>
            <div class="card-row" id="char-list"></div>
            
            <div class="section-title">ä¸»æ­¦å™¨é‡‡è´­</div>
            <div class="card-row" id="weapon-list"></div>

            <div class="section-title">é˜²å…·é€‰æ‹©</div>
            <div class="card-row" id="armor-list"></div>
        </div>
        <div id="checkout-bar">
            <div class="bill-display">
                <span style="font-size:10px; color:#666;">é¢„è®¡èŠ±è´¹</span>
                <span class="bill-total" id="ui-total-cost">$0</span>
            </div>
            <button class="btn-main" onclick="UI.showConfirmModal()">å¼€å§‹è¡ŒåŠ¨</button>
        </div>
    </div>

    <!-- 2. æ¸¸æˆå†… -->
    <div id="screen-game" class="screen">
        <div id="game-location-header">ğŸ“ <span id="ui-loc">éƒ¨ç½²ä¸­...</span></div>
        <div id="game-log-container"></div>
    </div>

    <!-- 3. æˆ˜æ–— -->
    <div id="screen-combat" class="screen">
        <div class="combat-stage">
            <div class="fighter-wrapper enemy" id="fighter-enemy">
                <img id="enemy-img" class="fighter-avatar" src="">
                <div class="fighter-info">
                    <div id="enemy-name" style="font-weight:bold; color:var(--danger)">æ•Œäºº</div>
                    <div class="hp-bar-bg"><div class="hp-bar-fill" id="enemy-hp-bar" style="width:100%"></div></div>
                    <div id="enemy-hp-text" style="font-size:10px; color:#fff">100/100</div>
                </div>
            </div>
            <div class="fighter-wrapper player" id="fighter-player">
                <img id="player-img" class="fighter-avatar" src="">
                <div class="fighter-info">
                    <div id="player-name" style="font-weight:bold; color:var(--highlight)">æˆ‘æ–¹</div>
                    <div class="hp-bar-bg"><div class="hp-bar-fill" id="player-hp-bar" style="width:100%"></div></div>
                    <div id="player-hp-text" style="font-size:10px; color:#fff">100/100</div>
                </div>
            </div>
        </div>
        <div class="combat-log-area" id="combat-log"></div>
    </div>

    <!-- å¼¹çª—ï¼šæœåˆ® -->
    <div id="modal-loot" class="modal-overlay">
        <div id="loot-anim" style="text-align:center">
            <div class="magnify-glass">ğŸ”</div>
            <div style="color:#aaa; margin-top:10px;">æ­£åœ¨æœç´¢ç‰©èµ„...</div>
        </div>
        <div id="loot-result" class="loot-card">
            <div id="loot-shine" style="font-size:12px; margin-bottom:5px; font-weight:bold;">è·å¾—ç‰©å“</div>
            <img id="loot-item-img" style="width:80px; height:80px; object-fit:contain; margin-bottom:10px;" src="">
            <div id="loot-item-name" style="font-size:16px; font-weight:bold; margin-bottom:5px; color:#fff">ç‰©å“å</div>
            <div id="loot-item-val" style="color:var(--gold); margin-bottom:15px; font-weight:bold">$0</div>
            <button class="btn-main" onclick="Game.closeLootModal()" style="width:100%">æ”¶ä¸‹</button>
        </div>
    </div>

    <!-- å¼¹çª—ï¼šå¤§çº¢å±•è§ˆé¦† -->
    <div id="modal-exhibition" class="modal-overlay">
        <button class="btn-close-modal" onclick="document.getElementById('modal-exhibition').style.display='none'">å…³é—­ X</button>
        <h3 style="color:var(--danger); border-bottom:1px solid #441111; padding-bottom:10px; width:90%; text-align:center;">ğŸ† å¤§çº¢å±•è§ˆé¦†</h3>
        <div class="exhibition-grid" id="museum-grid"></div>
    </div>

    <!-- å¼¹çª—ï¼šå‡ºå‡»ç¡®è®¤ -->
    <div id="modal-confirm" class="modal-overlay">
        <div class="confirm-box">
            <h3 style="margin-top:0; color:var(--text-main); text-align:center;">è¡ŒåŠ¨ç¡®è®¤</h3>
            <div class="conf-row"><span style="color:#888">å½“å‰èµ„é‡‘:</span><span id="conf-balance" style="font-family:monospace">$0</span></div>
            <div class="conf-row"><span style="color:#888">æœ¬æ¬¡æŠ•å…¥:</span><span id="conf-cost" style="color:var(--danger); font-family:monospace">-$0</span></div>
            <div class="conf-row" style="border-top:1px solid #444; padding-top:10px; font-weight:bold; color:var(--gold);">
                <span>é¢„è®¡å‰©ä½™:</span><span id="conf-remain" style="font-family:monospace">$0</span>
            </div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button style="flex:1; background:transparent; border:1px solid #444; color:#aaa; padding:10px; border-radius:6px;" onclick="document.getElementById('modal-confirm').style.display='none'">å–æ¶ˆ</button>
                <button class="btn-main" style="flex:1;" onclick="Game.finalStart()">ç¡®è®¤æ”¯ä»˜</button>
            </div>
        </div>
    </div>

<script>
const W = 10000;
const DATA = {
    chars: [
        { id: 0, name: 'å¨é¾™', role: 'çªå‡»', stats: {atk: 12, hp: 140}, img: 'https://placehold.co/100/222/FFF?text=å¨é¾™' },
        { id: 1, name: 'èœ‚åŒ»', role: 'æ”¯æ´', stats: {atk: 8, hp: 180}, img: 'https://placehold.co/100/222/FFF?text=èœ‚åŒ»' },
        { id: 2, name: 'çº¢ç‹¼', role: 'ä¾¦æŸ¥', stats: {atk: 10, hp: 120}, img: 'https://placehold.co/100/222/FFF?text=çº¢ç‹¼' }
    ],
    weapons: [
        { id: 0, name: 'æˆ˜æœ¯åŒ•é¦–', cost: 0, atk: 10, img: 'https://placehold.co/100/333/FFF?text=åŒ•é¦–' },
        { id: 1, name: 'MP5å†²é”‹æª', cost: 2*W, atk: 25, img: 'https://placehold.co/100/333/FFF?text=MP5' },
        { id: 2, name: 'M4A1æ­¥æª', cost: 5*W, atk: 45, img: 'https://placehold.co/100/333/FFF?text=M4A1' },
        // æ–°å¢æ»¡æ”¹M7ï¼šé«˜ä»·å€¼ï¼Œé«˜ä¼¤å®³
        { id: 3, name: 'æ»¡æ”¹M7', cost: 100*W, atk: 80, img: 'https://placehold.co/100/333/FFF?text=æ»¡æ”¹M7' }
    ],
    armor: [
        { id: 0, name: 'æ— é˜²å…·', cost: 0, hp: 0, img: 'https://placehold.co/100/222/FFF?text=æ— ' },
        { id: 1, name: '1çº§è½»ç”²', cost: 2*W, hp: 50, img: 'https://placehold.co/100/444/FFF?text=1çº§ç”²' },
        { id: 2, name: '3çº§æˆ˜æœ¯ç”²', cost: 5*W, hp: 100, img: 'https://placehold.co/100/555/FFF?text=3çº§ç”²' },
        { id: 3, name: '5çº§é‡ç”²', cost: 10*W, hp: 200, img: 'https://placehold.co/100/666/FFF?text=5çº§ç”²' }
    ],
    enemies: [
        { name: 'æ¸¸è¡è€…', hp: 80, atk: 12, img: 'https://placehold.co/100/511/FFF?text=AI' },
        { name: 'å…¨è£…ç‰¹é£', hp: 160, atk: 30, img: 'https://placehold.co/100/811/FFF?text=Enemy' },
        { name: 'é¦–é¢†é˜¿è¨æ‹‰', hp: 400, atk: 45, img: 'https://placehold.co/100/800/FFF?text=BOSS' },
        { name: 'å…¨è£…çŒ›æ”»å“¥', hp: 160, atk: 75, img: 'https://placehold.co/100/8b0000/FFF?text=çŒ›æ”»å“¥' }
    ],
    lootTable: [
        { name: 'æµ·æ´‹ä¹‹æ³ª', val: 1300*W, tier: 3, weight: 0.5, img: 'https://placehold.co/120/ff4444/FFF?text=æµ·æ´‹ä¹‹æ³ª' },
        { name: 'éæ´²ä¹‹å¿ƒ', val: 1000*W, tier: 3, weight: 0.8, img: 'https://placehold.co/120/ff4444/FFF?text=éæ´²ä¹‹å¿ƒ' },
        { name: 'å†›ç”¨ç»ˆç«¯', val: 500*W, tier: 3, weight: 2.0, img: 'https://placehold.co/120/ff4444/FFF?text=å†›ç”¨ç»ˆç«¯' },
        { name: 'æ’æ˜Ÿæ•æ„Ÿå™¨',val: 450*W, tier: 3, weight: 2.0, img: 'https://placehold.co/120/ff4444/FFF?text=æ•æ„Ÿå™¨' },
        { name: 'FASTæ”¶çº³ç®±',val: 200*W, tier: 3, weight: 3.0, img: 'https://placehold.co/120/ff4444/FFF?text=FASTç®±' },
        { name: 'é›·æ˜é¡¿æ‰“å­—æœº',val:180*W, tier: 3, weight: 2.0, img: 'https://placehold.co/120/ff4444/FFF?text=æ‰“å­—æœº' },
        { name: 'æ˜¾å¡',       val: 150*W, tier: 3, weight: 3.0, img: 'https://placehold.co/120/ff4444/FFF?text=æ˜¾å¡' },
        { name: 'é‡‘æ¡',       val: 120*W, tier: 3, weight: 4.0, img: 'https://placehold.co/120/ff4444/FFF?text=é‡‘æ¡' },
        { name: 'é©¬ä¸Šèµ·é£',   val: 100*W, tier: 3, weight: 1.0, img: 'https://placehold.co/120/ff4444/FFF?text=é©¬ä¸Šèµ·é£' },
        { name: 'è¸æµªåœ°ç‚‰',   val: 80*W,  tier: 3, weight: 1.5, img: 'https://placehold.co/120/ff4444/FFF?text=è¸æµªåœ°ç‚‰' },
        { name: 'é«˜çº§å’–å•¡è±†', val: 30*W,  tier: 3, weight: 1.0, img: 'https://placehold.co/120/ff4444/FFF?text=å’–å•¡è±†' },
        { name: 'æ¶²å‹ç ´é—¨å™¨', val: 9*W,   tier: 2, weight: 5.0, img: 'https://placehold.co/120/ffd700/000?text=ç ´é—¨å™¨' },
        { name: 'é£è¡Œå‘˜çœ¼é•œ', val: 9*W,   tier: 2, weight: 20.0,img: 'https://placehold.co/120/ffd700/000?text=çœ¼é•œ' },
        { name: 'å“ˆå¼—å…‹æ¡£æ¡ˆ', val: 8*W,   tier: 2, weight: 10.0,img: 'https://placehold.co/120/ffd700/000?text=æœºå¯†æ¡£æ¡ˆ' },
        { name: 'è„‘æœºæŠ¥å‘Š',   val: 7*W,   tier: 2, weight: 8.0, img: 'https://placehold.co/120/ffd700/000?text=è„‘æœºæŠ¥å‘Š' },
        { name: 'æ„Ÿåº”é­”æ–¹',   val: 6*W,   tier: 2, weight: 15.0,img: 'https://placehold.co/120/ffd700/000?text=é­”æ–¹' },
        { name: 'æ®‹ç¼ºçš„æ¡£æ¡ˆ', val: 5*W,   tier: 1, weight: 60.0,img: 'https://placehold.co/120/d2a8ff/000?text=æ®‹ç¼ºæ¡£æ¡ˆ' },
        { name: 'ç›’è£…å’–å•¡',   val: 3*W,   tier: 1, weight: 30.0,img: 'https://placehold.co/120/d2a8ff/000?text=ç›’è£…å’–å•¡' },
        { name: 'ç”µåŠ¨é©¬è¾¾',   val: 3*W,   tier: 1, weight: 5.0, img: 'https://placehold.co/120/d2a8ff/000?text=é©¬è¾¾' },
        { name: 'å…¸é›…å’–å•¡æ¯', val: 2*W,   tier: 1, weight: 50.0,img: 'https://placehold.co/120/d2a8ff/000?text=å’–å•¡æ¯' },
        { name: 'é•œå¤´',       val: 2*W,   tier: 1, weight: 40.0,img: 'https://placehold.co/120/d2a8ff/000?text=é•œå¤´' },
    ]
};

function fmtMoney(num) {
    if(num >= 10000) return Math.floor(num/10000) + "ä¸‡";
    return num; 
}

const State = {
    money: 300000, 
    sel: { char: 0, weap: 0, armor: 0 },
    game: { curHp: 0, maxHp: 0, atk: 0, bagVal: 0, bag: [] },
    combat: null
};

const Storage = {
    keyExhib: 'delta_exhibition_v6',
    unlockRedItem: (itemName) => {
        let db = Storage.getExhibition();
        if(!db[itemName]) db[itemName] = 0;
        db[itemName]++;
        localStorage.setItem(Storage.keyExhib, JSON.stringify(db));
    },
    getExhibition: () => {
        const s = localStorage.getItem(Storage.keyExhib);
        return s ? JSON.parse(s) : {};
    }
};

const UI = {
    init: () => {
        document.getElementById('char-list').innerHTML = DATA.chars.map((c,i) => `
            <div class="card ${i===0?'selected':''}" onclick="UI.sel('char', ${i}, this)">
                <img src="${c.img}"><div class="card-info"><b>${c.name}</b><br>
                    <span class="stat-badge" style="color:var(--highlight)">âš”ï¸${c.stats.atk}</span>
                    <span class="stat-badge" style="color:var(--green)">â¤ï¸${c.stats.hp}</span>
                </div>
            </div>`).join('');
        
        document.getElementById('weapon-list').innerHTML = DATA.weapons.map((w,i) => `
            <div class="card ${i===0?'selected':''}" onclick="UI.sel('weap', ${i}, this)">
                <img src="${w.img}"><div class="card-info"><b>${w.name}</b><br>
                    <span style="color:var(--gold)">$${fmtMoney(w.cost)}</span><br>
                    <span class="stat-badge" style="color:var(--danger)">âš”ï¸+${w.atk}</span>
                </div>
            </div>`).join('');

        document.getElementById('armor-list').innerHTML = DATA.armor.map((a,i) => `
            <div class="card ${i===0?'selected':''}" onclick="UI.sel('armor', ${i}, this)">
                <img src="${a.img}"><div class="card-info"><b>${a.name}</b><br>
                    <span style="color:var(--gold)">$${fmtMoney(a.cost)}</span><br>
                    <span class="stat-badge" style="color:var(--highlight)">ğŸ›¡ï¸+${a.hp}</span>
                </div>
            </div>`).join('');
        UI.updateLobby();
    },

    sel: (type, idx, el) => {
        State.sel[type] = idx;
        el.parentElement.querySelectorAll('.card').forEach(c=>c.classList.remove('selected'));
        el.classList.add('selected');
        UI.updateLobby();
    },

    updateLobby: () => {
        const cost = DATA.weapons[State.sel.weap].cost + DATA.armor[State.sel.armor].cost;
        document.getElementById('ui-money').innerText = fmtMoney(State.money);
        document.getElementById('ui-total-cost').innerText = `$${fmtMoney(cost)}`;
    },

    showExhibition: () => {
        const modal = document.getElementById('modal-exhibition');
        const grid = document.getElementById('museum-grid');
        const owned = Storage.getExhibition();
        const redItems = DATA.lootTable.filter(i => i.tier === 3);

        grid.innerHTML = redItems.map(item => {
            const count = owned[item.name] || 0;
            const isUnlocked = count > 0;
            return `
                <div class="museum-card ${isUnlocked ? 'unlocked' : ''}">
                    <img src="${item.img}" class="museum-img">
                    <div class="museum-name">${item.name}</div>
                    <div class="museum-count">${isUnlocked ? 'å·²æ”¶è—: '+count : 'æœªè§£é”'}</div>
                </div>
            `;
        }).join('');
        modal.style.display = 'flex';
    },

    showConfirmModal: () => {
        const cost = DATA.weapons[State.sel.weap].cost + DATA.armor[State.sel.armor].cost;
        if(State.money < cost) return alert("èµ„é‡‘ä¸è¶³ï¼");
        document.getElementById('conf-balance').innerText = `$${fmtMoney(State.money)}`;
        document.getElementById('conf-cost').innerText = `-$${fmtMoney(cost)}`;
        document.getElementById('conf-remain').innerText = `$${fmtMoney(State.money - cost)}`;
        document.getElementById('modal-confirm').style.display = 'flex';
    },

    showScreen: (id) => {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    },
    chat: (text, type='normal') => {
        const c = document.getElementById('game-log-container');
        const d = document.createElement('div');
        d.className = `chat-bubble ${type}`;
        d.innerHTML = text;
        c.appendChild(d);
        c.scrollTop = c.scrollHeight;
    },
    ask: (opts) => {
        const c = document.getElementById('game-log-container');
        const d = document.createElement('div');
        d.className = 'choice-container';
        opts.forEach(o => {
            const b = document.createElement('button');
            b.className = 'chat-btn';
            b.innerText = o.txt;
            b.onclick = () => { d.remove(); UI.chat(`> ${o.txt}`, 'system'); o.cb(); };
            d.appendChild(b);
        });
        c.appendChild(d);
        c.scrollTop = c.scrollHeight;
    }
};

const Game = {
    finalStart: () => {
        document.getElementById('modal-confirm').style.display = 'none';
        const cost = DATA.weapons[State.sel.weap].cost + DATA.armor[State.sel.armor].cost;
        State.money -= cost;
        const c = DATA.chars[State.sel.char];
        const w = DATA.weapons[State.sel.weap];
        const a = DATA.armor[State.sel.armor];
        const totalHp = c.stats.hp + a.hp;
        State.game = { curHp: totalHp, maxHp: totalHp, atk: c.stats.atk + w.atk, bagVal: 0, bag: [] };
        
        UI.showScreen('screen-game');
        document.getElementById('game-log-container').innerHTML = '';
        document.getElementById('ui-hp-global').innerText = '100%';
        document.getElementById('ui-bag').innerText = '0';
        Game.flow('START');
    },

    flow: (step) => {
        if(step === 'START') {
            document.getElementById('ui-loc').innerText = "é›¶å·å¤§åÂ·å¤–å›´";
            UI.chat("æ“ä½œå·²å¼€å§‹ã€‚æ³¨æ„ï¼Œå¤§ååŒºåŸŸä¿¡å·æä¸ç¨³å®šã€‚", 'event');
            setTimeout(() => {
                UI.chat("ä¾¦æµ‹åˆ°ä¸¤ä¸ªé«˜ä»·å€¼åŒºåŸŸã€‚");
                UI.ask([
                    { txt: "è¡Œæ”¿æ¥¼ (é«˜å±/é«˜çˆ†ç‡)", cb: ()=>Game.flow('ADMIN') },
                    { txt: "æ¸¸å®¢ä¸­å¿ƒ (å®‰å…¨)", cb: ()=>Game.flow('VISITOR') }
                ]);
            }, 800);
        }
        else if(step === 'ADMIN') {
            document.getElementById('ui-loc').innerText = "è¡Œæ”¿æ¥¼";
            UI.chat("è¡Œæ”¿æ¥¼å†…éƒ¨å…‰çº¿æ˜æš—...", 'event');
            if(Math.random() < 0.7) { 
                if(Math.random() < 0.15) {
                    UI.chat("<b style='color:var(--dark-red)'>è„šæ­¥å£°æ²‰é‡...å…¨è£…çŒ›æ”»å“¥å‡ºç°ï¼</b>", 'system');
                    setTimeout(() => Game.initCombat('rusher'), 1000);
                } else {
                    UI.chat("é­é‡å…¨è£…åŸ‹ä¼ï¼", 'system');
                    setTimeout(() => Game.initCombat('hard'), 1000);
                }
            } else {
                UI.chat("å‘ç°ä¸€ä¸ªæœªå¼€å¯çš„æœºå¯†ä¿é™©ç®±ã€‚");
                UI.ask([{ txt: "ç ´è¯‘å¯†ç ", cb: ()=>Game.loot('high') }]);
            }
        }
        else if(step === 'VISITOR') {
            document.getElementById('ui-loc').innerText = "æ¸¸å®¢ä¸­å¿ƒ";
            UI.chat("è¿™é‡Œæ¯”è¾ƒå®‰é™ï¼Œåªæœ‰ä¸€äº›é›¶æ•£ç‰©èµ„ã€‚", 'event');
            if(Math.random() < 0.3) {
                UI.chat("æœ‰æ¸¸è¡è€…åœ¨å·¡é€»ã€‚", 'system');
                setTimeout(() => Game.initCombat('easy'), 1000);
            } else {
                UI.chat("å‘ç°ä¸€ä¸ªæ—…è¡ŒåŒ…ã€‚");
                UI.ask([{ txt: "æœåˆ®", cb: ()=>Game.loot('low') }]);
            }
        }
        else if(step === 'AFTER') {
            UI.chat("åŒºåŸŸå·²è‚ƒæ¸…ã€‚ä¸‹ä¸€æ­¥ï¼Ÿ");
            UI.ask([
                { txt: "ç»§ç»­æ¢ç´¢", cb: ()=>Game.flow(Math.random()>0.5?'ADMIN':'VISITOR') },
                { txt: "å‘¼å«æ’¤ç¦»", cb: ()=>Game.extract() }
            ]);
        }
    },

    loot: (bias) => {
        const m = document.getElementById('modal-loot');
        m.style.display = 'flex';
        document.getElementById('loot-anim').style.display = 'block';
        document.getElementById('loot-result').style.display = 'none';
        
        let pool = DATA.lootTable;
        if (bias === 'low' || bias === 'scavenger') {
            if(Math.random() > 0.001) pool = pool.filter(i => i.tier < 3);
        }
        else if (bias === 'elite') {
        }
        else if (bias === 'boss' || bias === 'high') {
            pool = pool.filter(i => i.tier >= 2);
        }
        else if (bias === 'rusher') {
            pool = pool.filter(i => i.tier >= 2); 
            if(Math.random() < 0.8) {
                pool = pool.filter(i => i.tier === 3);
            } else {
                pool = pool.filter(i => i.tier === 2);
            }
        }

        const totalWeight = pool.reduce((sum, item) => sum + item.weight, 0);
        let random = Math.random() * totalWeight;
        let selectedItem = pool[0];
        for (const item of pool) {
            if (random < item.weight) {
                selectedItem = item;
                break;
            }
            random -= item.weight;
        }

        let wait = 1000;
        if(selectedItem.tier === 2) wait = 1800;
        if(selectedItem.tier === 3) wait = 3000;

        setTimeout(() => {
            document.getElementById('loot-anim').style.display = 'none';
            document.getElementById('loot-result').style.display = 'block';
            
            const img = document.getElementById('loot-item-img');
            const name = document.getElementById('loot-item-name');
            const val = document.getElementById('loot-item-val');
            const shine = document.getElementById('loot-shine');
            const card = document.getElementById('loot-result');

            img.src = selectedItem.img;
            name.innerText = selectedItem.name;
            val.innerText = `$${fmtMoney(selectedItem.val)}`;
            
            card.style.borderColor = '#444';
            card.style.boxShadow = 'none';
            name.style.color = '#fff';
            shine.style.color = '#fff';

            if(selectedItem.tier === 3) {
                card.style.borderColor = 'var(--danger)';
                card.style.boxShadow = '0 0 30px var(--danger)';
                name.style.color = 'var(--danger)';
                shine.innerText = "!!! æè‡´çå“ !!!";
                shine.style.color = 'var(--danger)';
            } else if(selectedItem.tier === 2) {
                name.style.color = 'var(--gold)';
                shine.innerText = "é«˜ä»·å€¼ç‰©èµ„";
                shine.style.color = 'var(--gold)';
            } else {
                name.style.color = 'var(--purple)';
                shine.innerText = "ç‰©èµ„å‘ç°";
            }
            Game.tempItem = selectedItem;
        }, wait);
    },
    
    closeLootModal: () => {
        document.getElementById('modal-loot').style.display = 'none';
        State.game.bag.push(Game.tempItem);
        State.game.bagVal += Game.tempItem.val;
        document.getElementById('ui-bag').innerText = fmtMoney(State.game.bagVal);
        UI.chat(`è·å¾— <span style="color:${Game.tempItem.tier===3?'var(--danger)':'var(--highlight)'}">[${Game.tempItem.name}]</span>`, 'system');
        Game.flow('AFTER');
    },

    initCombat: (diff) => {
        UI.showScreen('screen-combat');
        let enemy = DATA.enemies[0];
        if(diff === 'hard') enemy = DATA.enemies[1];
        if(diff === 'boss') enemy = DATA.enemies[2];
        if(diff === 'rusher') enemy = DATA.enemies[3];

        State.combat = { round: 0, enemy: { ...enemy, maxHp: enemy.hp }, player: State.game };
        document.getElementById('combat-log').innerHTML = '<div style="color:#aaa">>>> æˆ˜æ–—ç³»ç»Ÿå¯åŠ¨ <<<</div>';
        document.getElementById('enemy-img').src = enemy.img;
        document.getElementById('enemy-name').innerText = enemy.name;
        document.getElementById('player-img').src = DATA.chars[State.sel.char].img;
        Game.updateCombatBars();
        setTimeout(Game.turnPlayer, 1000);
    },

    updateCombatBars: () => {
        const c = State.combat;
        const ep = Math.max(0, (c.enemy.hp / c.enemy.maxHp) * 100);
        document.getElementById('enemy-hp-bar').style.width = ep + '%';
        document.getElementById('enemy-hp-text').innerText = `${c.enemy.hp}/${c.enemy.maxHp}`;
        const pp = Math.max(0, (c.player.curHp / c.player.maxHp) * 100);
        document.getElementById('player-hp-bar').style.width = pp + '%';
        document.getElementById('player-hp-text').innerText = `${c.player.curHp}/${c.player.maxHp}`;
        document.getElementById('ui-hp-global').innerText = Math.floor(pp) + '%';
    },

    showDmg: (targetId, dmg) => {
        const wrapper = document.getElementById(targetId);
        const el = document.createElement('div');
        el.className = 'dmg-popup';
        el.innerText = `-${dmg}`;
        wrapper.appendChild(el);
        setTimeout(() => el.remove(), 1000);
        const img = wrapper.querySelector('img');
        img.classList.add('shake-anim', 'hit-flash');
        setTimeout(() => img.classList.remove('shake-anim', 'hit-flash'), 400);
    },

    turnPlayer: () => {
        if(State.combat.player.curHp <= 0) return Game.endCombat(false);
        document.getElementById('player-img').classList.add('atk-lunge-right');
        setTimeout(() => document.getElementById('player-img').classList.remove('atk-lunge-right'), 300);
        const dmg = Math.floor(State.combat.player.atk * (0.9 + Math.random()*0.3));
        State.combat.enemy.hp -= dmg;
        if(State.combat.enemy.hp < 0) State.combat.enemy.hp = 0;
        setTimeout(() => {
            Game.showDmg('fighter-enemy', dmg);
            Game.updateCombatBars();
            Game.logCombat(`ä½ å°„å‡»é€ æˆ <span style="color:#ff6b6b">${dmg}</span> ä¼¤å®³`);
            if(State.combat.enemy.hp <= 0) setTimeout(() => Game.endCombat(true), 1200);
            else setTimeout(Game.turnEnemy, 1500);
        }, 300);
    },

    turnEnemy: () => {
        if(State.combat.enemy.hp <= 0) return;
        document.getElementById('enemy-img').classList.add('atk-lunge-left');
        setTimeout(() => document.getElementById('enemy-img').classList.remove('atk-lunge-left'), 300);
        const dmg = Math.floor(State.combat.enemy.atk * (0.8 + Math.random()*0.4));
        State.combat.player.curHp -= dmg;
        if(State.combat.player.curHp < 0) State.combat.player.curHp = 0;
        setTimeout(() => {
            Game.showDmg('fighter-player', dmg);
            Game.updateCombatBars();
            Game.logCombat(`${State.combat.enemy.name} åå‡»é€ æˆ <span style="color:#ff6b6b">${dmg}</span> ä¼¤å®³`);
            if(State.combat.player.curHp <= 0) setTimeout(() => Game.endCombat(false), 1200);
            else setTimeout(Game.turnPlayer, 1500);
        }, 300);
    },

    logCombat: (msg) => {
        const d = document.createElement('div');
        d.innerHTML = `> ${msg}`;
        const box = document.getElementById('combat-log');
        box.appendChild(d);
        box.scrollTop = box.scrollHeight;
    },

    endCombat: (win) => {
        if(win) {
            UI.showScreen('screen-game'); 
            const enemyName = State.combat.enemy.name;
            UI.chat(`å¨èƒæ¸…é™¤ï¼å‡»è´¥äº† <span style="color:var(--danger)">${enemyName}</span>`, 'event');
            
            let lootBias = 'scavenger'; 
            if(enemyName === 'å…¨è£…ç‰¹é£') lootBias = 'elite';
            if(enemyName === 'é¦–é¢†é˜¿è¨æ‹‰') lootBias = 'boss';
            if(enemyName === 'å…¨è£…çŒ›æ”»å“¥') lootBias = 'rusher'; 

            UI.ask([
                { txt: "æœç´¢èƒŒåŒ…", cb: () => Game.loot(lootBias) }, 
                { txt: "ç›´æ¥ç¦»å¼€", cb: () => Game.flow('AFTER') }
            ]);
        } else {
            alert("ä½ å·²é˜µäº¡...");
            location.reload();
        }
    },

    extract: () => {
        UI.chat("æ­£åœ¨å‘¼å«æ’¤ç¦»...", 'event');
        setTimeout(() => {
            const profit = State.game.bagVal;
            alert(`æ’¤ç¦»æˆåŠŸï¼\nå¸¦å‡ºæ”¶ç›Š: $${fmtMoney(profit)}`);
            State.game.bag.forEach(item => {
                if(item.tier === 3) {
                    Storage.unlockRedItem(item.name);
                    alert(`>>> æ­å–œï¼æ”¶è—å“å…¥åº“: ${item.name} <<<`);
                }
            });
            State.money += profit;
            UI.showScreen('screen-lobby');
            UI.updateLobby();
        }, 1500);
    }
};

UI.init();
</script>
</body>
</html>
